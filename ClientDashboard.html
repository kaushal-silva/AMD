<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMD Client Dashboard | Tabbed View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .section-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .alert-red {
            background-color: #fef2f2;
            border-left: 4px solid #ef4444;
            color: #b91c1c;
        }
        .chat-client {
            background-color: #dbeafe; /* Blue 100 */
            align-self: flex-end;
        }
        .chat-doctor {
            background-color: #ecfdf5; /* Teal 100 */
            align-self: flex-start;
        }
        .chat-amc {
            background-color: #f3e8ff; /* Indigo 100 */
            align-self: flex-start;
        }
        .tab-button {
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #4b5563;
            border-radius: 0.5rem;
            transition: all 0.15s ease;
        }
        .tab-button.active {
            background-color: #e0f2fe; /* Sky 100 */
            color: #0369a1; /* Sky 700 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border-right: 3px solid #0ea5e9;
        }
        .tab-button:not(.active):hover {
            background-color: #f3f4f6;
        }
        /* Custom styling for the range input thumb */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #0ea5e9;
            cursor: pointer;
            margin-top: -7px; 
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
        }
        /* Pipeline Styling (Kept for reference, but not used in top section anymore) */
        .pipeline-stage {
            @apply flex flex-col items-center flex-1 min-w-0 mx-1 relative z-10;
        }
        .pipeline-dot {
            @apply w-4 h-4 rounded-full border-2 border-gray-300 transition-all duration-300;
        }
        .pipeline-dot.current {
            @apply border-sky-500 bg-sky-100 ring-4 ring-sky-300;
        }
        .pipeline-dot.complete {
            @apply bg-teal-500 border-teal-500;
        }
        .pipeline-connector {
            @apply absolute top-1/2 left-0 right-0 h-1 bg-gray-200 z-0;
        }
        .pipeline-connector-progress {
            @apply absolute top-0 left-0 h-full bg-teal-400 transition-all duration-500;
        }
    </style>
</head>
<body>

    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-sky-600 shadow-md">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 id="header-title" class="text-3xl font-bold text-white" data-key="header_title">AMD Client Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <!-- Language Toggle Button -->
                    <button id="lang-toggle" onclick="toggleLanguage()" class="py-1 px-3 rounded-full bg-white text-sky-700 border border-sky-500 hover:bg-sky-100 transition duration-150 font-semibold text-sm shadow">
                        <!-- Text updated by JavaScript -->
                    </button>
                    <a href="index.html" class="text-sm font-medium text-sky-200 hover:text-white" data-key="logout_link">← Log Out / Portal</a>
                </div>
            </div>
        </header>

        <!-- Patient Key Information & Goals Overview (Reworked Top Section) -->
        <section class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Left Column (2/3): My Journey: Goals & Motivation (TAKE OVER LEFT SPACE) -->
                <div class="lg:col-span-2 section-card bg-white/70">
                    <h2 class="text-xl font-bold text-gray-800 mb-4" data-key="journey_title">My Journey</h2>
                    
                    <h3 class="text-2xl font-extrabold text-gray-900 border-b pb-2 text-sky-600" data-key="sec_goals_title_impact">Goals & Motivation</h3>
                    <p class="text-sm text-gray-600 my-4" data-key="goals_motivation_intro">Focus on these goals—they are the powerful symptoms we are working together to eliminate through holistic treatment.</p>
                            
                    <div class="mb-5">
                        <h4 class="font-bold text-gray-700 mb-2" data-key="goals_list_title">My 3 Symptoms to Eliminate:</h4>
                        <ul class="list-disc list-inside text-sm text-sky-700 font-semibold space-y-1 pl-4">
                            <li data-key="goal1">Chronic Daytime Fatigue</li>
                            <li data-key="goal2">Frequent Neck/Shoulder Tension</li>
                            <li data-key="goal3">Waking up with dry mouth</li>
                        </ul>
                    </div>
                    
                    <button class="w-full py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm font-medium" data-key="btn_update_goals">Update Pains & Goals</button>
                </div>

                <!-- Right Column (1/3): Key Contacts -->
                <div class="lg:col-span-1 section-card border-t-4 border-sky-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-4" data-key="key_contacts_title">Key Contacts & Appointments</h2>
                    
                    <div class="space-y-3 text-sm">
                        <p><strong data-key="patient_name_label">Patient:</strong> <span class="font-semibold">Mr. John Lee</span></p>
                        <p><strong data-key="patient_id_label">Patient ID:</strong> <span class="font-mono text-gray-600">AMDTW001</span></p>
                        <hr class="border-gray-100">
                        <p><strong data-key="dentist_label">Dentist:</strong> Dr. C. Lin (Harmony Clinic)</p>
                        <p><strong data-key="amc_label">AMC:</strong> Jane Chen</p>
                    </div>
                    
                    <hr class="border-gray-100 my-3">
                    
                    <p class="text-xs text-gray-500" data-key="next_appointment_label">Next Appointment:</p>
                    <p class="text-base font-bold text-sky-600 mb-3">Dec 20, 2025 at 10:00 AM</p>
                    
                    <button class="w-full py-2 bg-sky-500 text-white text-sm rounded-lg hover:bg-sky-600 font-medium" data-key="btn_create_appointment">
                        Create New Appointment
                    </button>
                </div>
            </div>
        </section>

        <!-- Main Content Area with Tabs -->
        <main class="max-w-7xl mx-auto pb-8 px-4 sm:px-6 lg:px-8">
            <div class="lg:grid lg:grid-cols-4 lg:gap-8">
                
                <!-- LEFT COLUMN: Navigation Tabs -->
                <div class="lg:col-span-1 mb-8 lg:mb-0">
                    <div class="bg-white p-4 rounded-xl shadow-lg lg:sticky lg:top-8">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 border-b pb-2" data-key="nav_title">Navigation</h3>
                        <nav class="flex flex-col space-y-2">
                            <button class="tab-button active" onclick="switchTab('my-plan')" data-key="tab_my_plan">
                                My Plan & Support
                            </button>
                            <button class="tab-button" onclick="switchTab('diagnostics')" data-key="tab_diagnostics">
                                Diagnostic Inputs
                            </button>
                            <button class="tab-button" onclick="switchTab('progress')" data-key="tab_progress">
                                Progress Tracker
                            </button>
                            <button class="tab-button" onclick="switchTab('chat')" data-key="tab_chat">
                                Secure Group Chat
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Tab Content -->
                <div class="lg:col-span-3 space-y-8">
                    
                    <!-- 1. My Plan & Support Tab (Default) -->
                    <div id="tab-my-plan" class="tab-content space-y-8">
                        
                        <!-- Removed My Journey: Goals & Motivation section to avoid duplication -->

                        <!-- Treatment Interventions (Improved UX) -->
                        <div class="section-card">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2 text-yellow-600" data-key="sec_interventions_title">Treatment Interventions</h2>

                            <!-- Start Thriving Appliance Section -->
                            <div class="mb-8 p-6 border rounded-lg bg-yellow-50/50">
                                <h3 class="font-bold text-gray-700 mb-2" data-key="appliance_title">Start Thriving Appliance (TM)</h3>
                                
                                <!-- Progress Bar and Time Left -->
                                <div class="mb-4">
                                    <p class="text-sm font-semibold text-gray-800" id="app_duration_text" data-key="app_duration_text">Total Prescription: 24 Months</p>
                                    <div class="flex items-center space-x-4 mt-2">
                                        <div class="flex-1">
                                            <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                                                <div id="appliance-progress-bar-detail" class="h-full bg-sky-500 transition-all duration-500" style="width: 25%;"></div>
                                            </div>
                                        </div>
                                        <span id="appliance-percentage" class="text-base font-extrabold text-sky-700">25%</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1" id="app_remaining_time" data-key="app_remaining_time">You have <span id="appliance-remaining-months">18</span> months remaining.</p>
                                </div>
                                
                                <!-- Interactive Timeline -->
                                <div class="mb-6 border-t pt-4">
                                    <h4 class="font-bold text-sm text-gray-700 mb-2" data-key="adjustment_timeline_title">View Appliance History (Month: <span id="display-month">6</span>)</h4>
                                    
                                    <!-- SLIDER: On input, update appliance details and historical note -->
                                    <input type="range" min="0" max="24" value="6" step="1" class="w-full h-2 bg-yellow-200 rounded-lg appearance-none cursor-pointer" id="appliance-timeline-slider" oninput="updateApplianceDetails(this.value)">
                                    <div class="flex justify-between text-xs mt-1 text-gray-500">
                                        <span data-key="app_start">Start</span>
                                        <span data-key="app_24m">24 Months</span>
                                    </div>
                                </div>


                                <!-- Dentist Note Section (DYNAMIC) -->
                                <div class="p-3 bg-teal-100 border border-teal-300 rounded-lg mb-4">
                                    <p class="font-bold text-teal-800 mb-1" id="dentist-note-title" data-key="dentist_note_title">Dentist Clinical Note (12/01/2025):</p>
                                    <p class="text-sm text-teal-700" id="dentist-note-content">Monitor patient's TMJ discomfort at current expansion rate (0.50mm). Continue myofunctional exercises daily. Next checkup scheduled for Month 8.</p>
                                </div>

                                <!-- Current Appliance Status Display (DYNAMIC) -->
                                <h4 class="font-semibold text-sm text-gray-700 mb-2" data-key="adjustment_summary_title">Current Appliance Setting</h4>

                                <div id="adjustment-list" class="space-y-2 text-sm text-gray-600 p-3 bg-yellow-100 rounded-lg">
                                    <p><strong data-key="adj_setting_label">Setting:</strong> <span id="adj-setting-value">2.0 Turns / 0.50mm Expansion</span></p>
                                    <p><strong data-key="adj_date_label">Last Adjusted:</strong> <span id="adj-date-value">15/11/2025</span></p>
                                    <p class="text-xs text-gray-500" id="adj-note-label" data-key="adj_note_label">Note: Active expansion phase. Monitor midline spacing.</p>
                                </div>
                                
                                <button class="mt-4 py-2 px-4 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 text-sm font-medium w-full" data-key="btn_request_adjustment">Request Appliance Adjustment / View History</button>
                            </div>

                            <!-- Nutrition Section -->
                            <div class="p-4 border rounded-lg bg-teal-50/50">
                                <h3 class="font-bold text-gray-700 mb-2" data-key="nutrition_title">Prescribed Nutrition Focus:</h3>
                                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1 pl-4 mb-3">
                                    <li data-key="nut_bonebroth">Increase intake of bone broth for collagen support.</li>
                                    <li data-key="nut_calcium">Ensure adequate calcium and magnesium levels.</li>
                                    <li data-key="nut_fattyacids">Focus on essential fatty acids (Omega-3).</li>
                                </ul>
                                <button class="w-full py-2 bg-indigo-500 text-white font-medium rounded-lg hover:bg-indigo-600 transition duration-150" data-key="btn_order_supplements">
                                    Order Supplements Now
                                </button>
                            </div>
                        </div>
                        
                        <!-- AMC Support -->
                        <div class="section-card">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2 text-teal-600" data-key="sec_amc_support_title">AMC & Support</h2>
                            <div class="mb-5">
                                <h3 class="font-bold text-gray-700 mb-2" data-key="amc_coordinator_title">Assigned Coordinator: Jane Chen (AMC)</h3>
                                <p class="text-sm text-gray-600 mb-3" data-key="amc_coordinator_desc">Your dedicated health coach for administrative and non-clinical guidance.</p>
                                <button class="w-full py-2 bg-teal-500 text-white font-medium rounded-lg hover:bg-teal-600 transition duration-150" data-key="btn_arrange_appointment">
                                    Arrange AMC Appointment
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Diagnostic Inputs Tab -->
                    <div id="tab-diagnostics" class="tab-content space-y-8 hidden">
                        <div class="section-card">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-2 text-indigo-600" data-key="sec_diagnostics_title">AMD Diagnostic Inputs</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                
                                <!-- 1. CB CT Scan -->
                                <div class="border p-4 rounded-lg bg-gray-50">
                                    <h3 class="font-bold text-indigo-700 mb-2" data-key="cbct_title">CB CT Scan (Airway)</h3>
                                    <p class="text-xs text-gray-600 mb-2" data-key="cbct_desc">Used to measure Minimal Cross Section (MCS).</p>
                                    
                                    <div class="font-semibold text-lg p-2 rounded-md mb-2 alert-red">
                                        <span data-key="mcs_value">MCS: 285 mm²</span> <span data-key="mcs_status">(Critical!)</span>
                                    </div>
                                    
                                    <p class="text-xs text-gray-500" data-key="cbct_note">Doctor Note (10/12/2025): Significant restriction noted in velopharynx. Immediate intervention required.</p>
                                    <button class="mt-2 text-sm text-indigo-500 hover:underline" data-key="btn_view_cbct">View Full Scan / Upload New</button>
                                </div>

                                <!-- 2. 3D Intra-Oral Scan -->
                                <div class="border p-4 rounded-lg bg-gray-50">
                                    <h3 class="font-bold text-indigo-700 mb-2" data-key="intraoral_title">3D Intra-Oral Scan (Teeth)</h3>
                                    <p class="text-xs text-gray-600 mb-2" data-key="intraoral_desc">Used for Schwarz Analysis measurements.</p>
                                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-2 rounded-md mb-2">
                                        <p class="text-xs font-semibold text-yellow-800" data-key="schwarz_status">Schwarz Analysis Ready</p>
                                    </div>
                                    <p class="text-xs text-gray-500" data-key="schwarz_note">Analysis shows 5mm maxillary posterior crossbite correction needed.</p>
                                    <button class="mt-2 text-sm text-indigo-500 hover:underline" data-key="btn_view_schwarz">View Analysis & Report</button>
                                </div>

                                <!-- 3. Ceph Flow Metric Analysis -->
                                <div class="border p-4 rounded-lg bg-gray-50">
                                    <h3 class="font-bold text-indigo-700 mb-2" data-key="ceph_title">Ceph Flow Metric Analysis</h3>
                                    <p class="text-xs text-gray-600 mb-2" data-key="ceph_desc">Used for Sassouni Plus Ceph Analysis.</p>
                                    <div class="bg-green-50 border-l-4 border-green-500 p-2 rounded-md mb-2">
                                        <p class="text-xs font-semibold text-green-800" data-key="sassouni_status">Sassouni Plus Report</p>
                                    </div>
                                    <p class="text-xs text-gray-500" data-key="sassouni_note">Informs appliance growth angles. Current FMA: 23°.</p>
                                    <button class="mt-2 text-sm text-indigo-500 hover:underline" data-key="btn_view_sassouni">View Report & Angles</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Progress Tracker Tab -->
                    <div id="tab-progress" class="tab-content space-y-8 hidden">
                        <div class="section-card">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-2 text-sky-600" data-key="progress_title">Progress Photo Timeline</h2>
                            <p class="text-sm text-gray-500 mb-4" data-key="progress_subtitle">Track your jaw and posture changes over the 18-month growth prescription period.</p>
                            
                            <!-- Comparison Slider and Images (Updated for multiple checkpoints) -->
                            <h3 class="font-bold text-gray-700 mb-4" data-key="comparison_view_title">Historical Comparison View</h3>
                            
                            <div class="bg-gray-100 p-4 rounded-lg mb-4">
                                <label for="comparison-slider" id="comparison-label" class="block text-sm font-medium text-gray-700 mb-2" data-key="viewing_photos">Viewing photos from: Month 6 Check</label>
                                <!-- Max set to 4 for 5 checkpoints (0 to 4) -->
                                <input type="range" min="0" max="4" value="0" step="1" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer" id="comparison-slider" oninput="updateComparisonView(this.value)">
                                <div class="flex justify-between text-xs mt-1 text-gray-500">
                                    <span data-key="comp_c0">Initial</span><span data-key="comp_c1">Month 3</span><span data-key="comp_c2">Month 6</span><span data-key="comp_c3">Month 12</span><span data-key="comp_c4">Current</span>
                                </div>
                            </div>

                            <div id="photo-comparison-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <!-- Photos injected by JavaScript -->
                            </div>

                            <button class="mt-6 w-full py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-600 text-sm font-medium" data-key="upload_photo">Upload New Progress Photo</button>
                        </div>
                    </div>

                    <!-- 4. Secure Group Chat Tab -->
                    <div id="tab-chat" class="tab-content space-y-8 hidden">
                         <div class="section-card">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2 text-blue-600" data-key="sec_chat_title">Secure Group Chat</h2>
                            <p class="text-sm text-gray-500 mb-4" data-key="chat_subtitle">Communicate directly with your Doctor and AMC.</p>
                            
                            <!-- Chat Box -->
                            <div class="h-80 overflow-y-auto p-4 border rounded-lg bg-gray-50 flex flex-col space-y-3">
                                
                                <!-- Doctor Message -->
                                <div class="p-3 rounded-xl max-w-[80%] chat-doctor shadow-sm">
                                    <p class="text-xs font-semibold text-teal-800" data-key="msg_doctor_title">Dr. Smith (Practitioner)</p>
                                    <p class="text-sm text-gray-800 mt-1" data-key="msg_doctor_text">Hello, I have reviewed your latest CBCT. Please ensure you are wearing the appliance for the full prescribed time daily.</p>
                                    <p class="text-xs text-gray-500 text-right mt-1">11:30 AM</p>
                                </div>

                                <!-- AMC Message -->
                                <div class="p-3 rounded-xl max-w-[80%] chat-amc shadow-sm">
                                    <p class="text-xs font-semibold text-indigo-800" data-key="msg_amc_title">Jane Chen (AMC)</p>
                                    <p class="text-sm text-gray-800 mt-1" data-key="msg_amc_text">I've scheduled your next nutrition coaching session for next Tuesday at 4 PM. Confirmation email sent.</p>
                                    <p class="text-xs text-gray-500 text-right mt-1">1:45 PM</p>
                                </div>

                                <!-- Client Message -->
                                <div class="p-3 rounded-xl max-w-[80%] bg-blue-100 shadow-sm self-end">
                                    <p class="text-xs font-semibold text-blue-800" data-key="msg_client_title">You (Client)</p>
                                    <p class="text-sm text-gray-800 mt-1" data-key="msg_client_text">Understood, Dr. Smith. I've been consistent. Jane, thank you for setting that up!</p>
                                    <p class="text-xs text-gray-500 text-right mt-1">2:01 PM</p>
                                </div>
                            </div>

                            <!-- Input Field Mock -->
                            <div class="mt-4 flex space-x-2">
                                <input type="text" id="chat-input" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Type your message...">
                                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium" data-key="btn_send">Send</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript for Tab Switching and Translations -->
    <script>
        let currentLang = 'en';
        const monthsCompleted = 6;
        const totalPrescriptionMonths = 24;
        const percentageCompleted = Math.round((monthsCompleted / totalPrescriptionMonths) * 100);

        // --- Appliance Timeline Logic (Mock Data) ---
        // Added more states for better slider interactivity
        const applianceAdjustments = [
            { month: 0, setKey: 'state_m0_set', expansion: '0.0mm', date: '2025/09/20', noteKey: 'note_m0', clinicalDate: '2025/09/20', clinicalNoteKey: 'note_clinical_m0' },
            { month: 2, setKey: 'state_m2_set', expansion: '1.0 Turns / 0.38mm', date: '2025/11/20', noteKey: 'note_m2', clinicalDate: '2025/11/15', clinicalNoteKey: 'note_clinical_m2' },
            { month: 4, setKey: 'state_m4_set', expansion: '1.5 Turns / 0.45mm', date: '2026/01/01', noteKey: 'note_m4', clinicalDate: '2025/12/28', clinicalNoteKey: 'note_clinical_m4' },
            { month: 6, setKey: 'state_m6_set', expansion: '2.0 Turns / 0.50mm', date: '2026/03/20', noteKey: 'note_m6', clinicalDate: '2026/03/15', clinicalNoteKey: 'note_clinical_m6' }
        ];

        // --- Patient Journey Stages (Simplified for Horizontal Pipeline) ---
        const stages = [
            { id: 'stage_1_signup', labelKey: 'flow_step_1_short' },
            { id: 'stage_2_select', labelKey: 'flow_step_2_short' },
            { id: 'stage_3_upload', labelKey: 'flow_step_3_short' },
            { id: 'stage_4_diagnosis', labelKey: 'flow_step_4_short' },
            { id: 'stage_5_treatment', labelKey: 'flow_step_5_short' }
        ];

        // Set the current phase the client is in (0-indexed)
        const currentPhaseIndex = 1; 

        // --- Core Translation Data Structure ---
        const translations = {
            'en': {
                'header_title': 'AMD Client Dashboard',
                'logout_link': '← Log Out / Portal',
                'journey_title': 'My Journey',
                'current_stage_label': 'Current Stage:',
                'key_contacts_title': 'Key Contacts & Appointments',
                'patient_name_label': 'Patient:',
                'patient_id_label': 'Patient ID:',
                'dentist_label': 'Dentist:',
                'amc_label': 'AMC:',
                'next_appointment_label': 'Next Appointment:',
                'btn_create_appointment': 'Create New Appointment',
                'adj_setting_label': 'Setting:',
                'adj_date_label': 'Last Adjusted:',
                'adj_note_label': 'Note:',
                'adjustment_summary_title': 'Current Appliance Setting',
                'app_duration_text': 'Total Prescription: 24 Months', 
                'app_remaining_time': 'You have [N] months remaining.', 
                'dentist_note_title': 'Dentist Clinical Note ([D]):', // Dynamic Date Placeholder
                'dentist_note_content': 'Monitor patient\'s TMJ discomfort at current expansion rate (0.50mm). Continue myofunctional exercises daily. Next checkup scheduled for Month 8.',
                'adjustment_timeline_title': 'View Appliance History (Month: [M])', 
                'btn_request_adjustment': 'Request Appliance Adjustment / View History',
                
                // Appliance States for History Mock
                'state_m0_set': 'Initial Fit (No Expansion)', 'note_m0': 'Baseline check and wear-time habit focus.',
                'state_m2_set': 'Active Expansion (1.0 Turn)', 'note_m2': 'First adjustment phase. Monitoring pressure and midline.',
                'state_m4_set': 'Active Expansion (1.5 Turns)', 'note_m4': 'Expansion increased. Good progress observed.',
                'state_m6_set': 'Expansion Maintained (2.0 Turns)', 'note_m6': 'Expansion maintained. TMJ stable. Re-evaluate CBCT at Month 9.',
                
                // Clinical Notes (Historical Mock)
                'note_clinical_m0': 'Patient cleared to begin appliance therapy. Initial focus on achieving 8-10 hours wear per night.',
                'note_clinical_m2': 'Midline tracking is good. Patient tolerates expansion well. Continue current rate.',
                'note_clinical_m4': 'Posture improvement noted. Patient reported less morning stiffness. Appliance setting adjustment confirmed.',
                'note_clinical_m6': 'Expansion maintained. TMJ stable. Re-evaluate expansion rate at Month 9.',


                // Journey Stages (Shortened for Pipeline)
                'flow_step_1_short': 'Assessment Done',
                'flow_step_2_short': 'Waiting for Dentist', 
                'flow_step_3_short': 'Upload Scans', 
                'flow_step_4_short': 'Diagnosis Visit',
                'flow_step_5_short': 'Active Treatment',
                
                'next_action_button': 'View Next Step',
                'nav_title': 'Navigation',
                'tab_my_plan': 'My Plan & Support',
                'tab_diagnostics': 'Diagnostic Inputs',
                'tab_progress': 'Progress Tracker',
                'tab_chat': 'Secure Group Chat',
                'sec_goals_title_impact': 'My Journey: Goals & Motivation',
                'goals_motivation_intro': 'Focus on these goals—they are the powerful symptoms we are working together to eliminate through holistic treatment.',
                'goals_list_title': 'My 3 Symptoms to Eliminate:',
                'goal1': 'Chronic Daytime Fatigue',
                'goal2': 'Frequent Neck/Shoulder Tension',
                'goal3': 'Waking up with dry mouth',
                'pains_list_title': 'Existing Pains/Conditions:',
                'pain1': 'Jaw clicking (Left TMJ)',
                'pain2': 'Morning headaches',
                'pain3': 'Reflux (GERD)',
                'btn_update_goals': 'Update Pains & Goals',
                'sec_interventions_title': 'Treatment Interventions',
                'appliance_title': 'Start Thriving Appliance (TM)',
                'appliance_duration_label': 'Prescription Progress:',
                'app_start': 'Start',
                'app_24m': '24 Months',
                'appliance_duration_text': `Prescription: ${totalPrescriptionMonths} months | ${monthsCompleted} months complete`,
                'adjustment_history_title': 'Adjustment History',
                'nutrition_title': 'Prescribed Nutrition Focus:',
                'nut_bonebroth': 'Increase intake of bone broth for collagen support.',
                'nut_calcium': 'Ensure adequate calcium and magnesium levels.',
                'nut_fattyacids': 'Focus on essential fatty acids (Omega-3).',
                'btn_order_supplements': 'Order Supplements Now',
                'sec_amc_support_title': 'AMC & Support',
                'amc_coordinator_title': 'Assigned Coordinator: Jane Chen (AMC)',
                'amc_coordinator_desc': 'Your dedicated health coach for administrative and non-clinical guidance.',
                'btn_arrange_appointment': 'Arrange AMC Appointment',
                'sec_diagnostics_title': 'AMD Diagnostic Inputs',
                'cbct_title': 'CB CT Scan (Airway)',
                'cbct_desc': 'Used to measure Minimal Cross Section (MCS).',
                'mcs_value': 'MCS: 285 mm²',
                'mcs_status': '(Critical!)',
                'cbct_note': 'Doctor Note (10/12/2025): Significant restriction noted in velopharynx. Immediate intervention required.',
                'btn_view_cbct': 'View Full Scan / Upload New',
                'intraoral_title': '3D Intra-Oral Scan (Teeth)',
                'intraoral_desc': 'Used for Schwarz Analysis measurements.',
                'schwarz_status': 'Schwarz Analysis Ready',
                'schwarz_note': 'Analysis shows 5mm maxillary posterior crossbite correction needed.',
                'btn_view_schwarz': 'View Analysis & Report',
                'ceph_title': 'Ceph Flow Metric Analysis',
                'ceph_desc': 'Used for Sassouni Plus Ceph Analysis.',
                'sassouni_status': 'Sassouni Plus Report',
                'sassouni_note': 'Informs appliance growth angles. Current FMA: 23°.',
                'btn_view_sassouni': 'View Report & Angles',
                'progress_title': 'Progress Photo Timeline',
                'progress_subtitle': 'Track your jaw and posture changes over the 18-month growth prescription period.',
                'comparison_view_title': 'Historical Comparison View',
                'viewing_photos': 'Viewing photos from: Month 6 Check',
                'comp_c0': 'Initial', 'comp_c1': 'Month 3', 'comp_c2': 'Month 6', 'comp_c3': 'Month 12', 'comp_c4': 'Current',
                'upload_photo': 'Upload New Progress Photo',
                'sec_chat_title': 'Secure Group Chat',
                'chat_subtitle': 'Communicate directly with your Doctor and AMC.',
                'msg_doctor_title': 'Dr. Smith (Practitioner)',
                'msg_doctor_text': 'Hello, I have reviewed your latest CBCT. Please ensure you are wearing the appliance for the full prescribed time daily.',
                'msg_amc_title': 'Jane Chen (AMC)',
                'msg_amc_text': "I've scheduled your next nutrition coaching session for next Tuesday at 4 PM. Confirmation email sent.",
                'msg_client_title': 'You (Client)',
                'msg_client_text': "Understood, Dr. Smith. I've been consistent. Jane, thank you for setting that up!",
                'btn_send': 'Send',
                'toggle_text': '中文'
            },
            'zh': {
                'header_title': 'AMD 客戶儀表板',
                'logout_link': '← 登出 / 入口網站',
                'journey_title': '我的旅程', // UPDATED
                'current_stage_label': '當前階段:',
                'key_contacts_title': '關鍵聯絡人與預約', // NEW
                'patient_name_label': '患者姓名:', // NEW
                'patient_id_label': '患者 ID:', // NEW
                'dentist_label': '牙醫:', // NEW
                'amc_label': 'AMC:', // NEW
                'next_appointment_label': '下次預約:', // NEW
                'btn_create_appointment': '創建新預約', // NEW
                'adj_setting_label': '設置:', // NEW
                'adj_date_label': '上次調整:', // NEW
                'adj_note_label': '備註:', // NEW
                'adjustment_summary_title': '當前矯治器設置', // NEW
                'app_duration_text': '總處方期: 24 個月', // NEW
                'app_remaining_time': '您還有 [N] 個月剩餘。', // NEW
                'dentist_note_title': '牙醫臨床備註 ([D]):', // Dynamic Date Placeholder
                'dentist_note_content': '在當前擴展率 (0.50mm) 下監測患者的 TMJ 不適。繼續每日進行口腔功能鍛鍊。下次檢查安排在第 8 個月。', // NEW KEY
                'adjustment_timeline_title': '查看矯治器歷史 (月份: [M])', // NEW KEY
                'btn_request_adjustment': '請求矯治器調整 / 查看歷史',

                // Appliance States for History Mock
                'state_m0_set': '初始佩戴 (無擴展)', 'note_m0': '基線檢查和佩戴習慣養成。',
                'state_m2_set': '活躍擴展階段 (1.0 圈)', 'note_m2': '第一階段調整。監測壓力和中線。',
                'state_m4_set': '活躍擴展階段 (1.5 圈)', 'note_m4': '擴展增加。觀察到良好進展。',
                'state_m6_set': '擴展維持階段 (2.0 圈)', 'note_m6': '擴展維持。TMJ 穩定。在第 9 個月重新評估擴展率。',

                // Journey Stages (Shortened for Pipeline)
                'flow_step_1_short': '評估完成',
                'flow_step_2_short': '等待牙醫確認',
                'flow_step_3_short': '上傳掃描',
                'flow_step_4_short': '診斷門診',
                'flow_step_5_short': '積極治療',
                
                'next_action_button': '查看下一步',
                'nav_title': '導航',
                'tab_my_plan': '我的計劃與支持',
                'tab_diagnostics': '診斷輸入',
                'tab_progress': '進度追踪器',
                'tab_chat': '安全群組聊天',
                'sec_goals_title_impact': '我的旅程：目標與動力',
                'goals_motivation_intro': '專注於這些目標—它們是我們正在通過整體治療共同努力消除的強大症狀。',
                'goals_list_title': '我的 3 個欲消除症狀:',
                'goal1': '慢性白天疲勞',
                'goal2': '頻繁頸部/肩部緊張',
                'goal3': '醒來時口乾',
                'pains_list_title': '現有疼痛/狀況:',
                'pain1': '下巴顳顎關節(左側)咯咯作響',
                'pain2': '早上頭痛',
                'pain3': '胃食道逆流 (GERD)',
                'btn_update_goals': '更新疼痛與目標',
                'sec_interventions_title': '治療干預措施',
                'appliance_title': '開始興盛矯治器 (TM)',
                'appliance_duration_label': '處方進度:',
                'app_start': '開始',
                'app_24m': '24 個月',
                'appliance_duration_text': `處方: ${totalPrescriptionMonths} 個月 | 完成 ${monthsCompleted} 個月`,
                'adjustment_history_title': '調整歷史記錄',
                'nutrition_title': '處方營養重點:',
                'nut_bonebroth': '增加骨湯攝取以支持膠原蛋白。',
                'nut_calcium': '確保充足的鈣和鎂水平。',
                'nut_fattyacids': '專注於必需脂肪酸 (Omega-3)。',
                'btn_order_supplements': '立即訂購補充劑',
                'sec_amc_support_title': 'AMC 與支持',
                'amc_coordinator_title': '指定協調員: Jane Chen (AMC)',
                'amc_coordinator_desc': '您專屬的健康教練，提供行政和非臨床指導。',
                'btn_arrange_appointment': '安排 AMC 預約',
                'sec_diagnostics_title': 'AMD 診斷輸入',
                'cbct_title': '錐束CT掃描 (氣道)',
                'cbct_desc': '用於測量最小橫截面積 (MCS)。',
                'mcs_value': 'MCS: 285 毫米²',
                'mcs_status': '(危急!)',
                'cbct_note': '醫生備註 (2025/12/10): 鼻咽部有明顯受限。需立即干預。',
                'btn_view_cbct': '查看完整掃描 / 上傳新掃描',
                'intraoral_title': '3D 口內掃描 (牙齒)',
                'intraoral_desc': '用於 Schwarz 分析測量。',
                'schwarz_status': 'Schwarz 分析準備就緒',
                'schwarz_note': '分析顯示上頜後部需要矯正 5 毫米的反頜。',
                'btn_view_schwarz': '查看分析與報告',
                'ceph_title': '頭影流動測量分析',
                'ceph_desc': '用於 Sassouni Plus 頭影分析。',
                'sassouni_status': 'Sassouni Plus 報告',
                'sassouni_note': '指導矯治器生長角度。當前 FMA: 23°。',
                'btn_view_sassouni': '查看報告與角度',
                'progress_title': '進度照片追踪器',
                'progress_subtitle': '追踪您在 18 個月生長處方期內的下巴和姿勢變化。',
                'comparison_view_title': '歷史比較視圖',
                'viewing_photos': '查看照片來自: 第 6 個月檢查',
                'comp_c0': '初始', 'comp_c1': '第 3 個月', 'comp_c2': '第 6 個月', 'comp_c3': '第 12 個月', 'comp_c4': '當前',
                'upload_photo': '上傳新進度照片',
                'sec_chat_title': '安全群組聊天',
                'chat_subtitle': '與您的醫生和 AMC 直接溝通。',
                'msg_doctor_title': 'Smith 醫生 (醫生)',
                'msg_doctor_text': '您好，我已經審閱了您最新的 CBCT。請確保每天在規定的時間內全程佩戴矯治器。',
                'msg_amc_title': 'Jane Chen (AMC)',
                'msg_amc_text': '我已經為您預約了下週二下午 4 點的營養指導課程。確認郵件已發送。',
                'msg_client_title': '您 (客戶)',
                'msg_client_text': '明白了，Smith 醫生。我一直很堅持。Jane，謝謝您的安排！',
                'btn_send': '發送',
                'toggle_text': 'English'
            }
        };

        // --- Appliance Timeline Logic (Mock Data) ---
        const applianceAdjustments = [
            { month: 0, setKey: 'state_m0_set', expansion: '0.0mm', date: '2025/09/20', noteKey: 'note_m0', clinicalDate: '2025/09/20', clinicalNoteKey: 'note_clinical_m0' },
            { month: 2, setKey: 'state_m2_set', expansion: '1.0 Turns / 0.38mm', date: '2025/11/20', noteKey: 'note_m2', clinicalDate: '2025/11/15', clinicalNoteKey: 'note_clinical_m2' },
            { month: 4, setKey: 'state_m4_set', expansion: '1.5 Turns / 0.45mm', date: '2026/01/01', noteKey: 'note_m4', clinicalDate: '2025/12/28', clinicalNoteKey: 'note_clinical_m4' },
            { month: 6, setKey: 'state_m6_set', expansion: '2.0 Turns / 0.50mm', date: '2026/03/20', noteKey: 'note_m6', clinicalDate: '2026/03/15', clinicalNoteKey: 'note_clinical_m6' }
        ];

        // --- Patient Journey Stages (Simplified for Horizontal Pipeline) ---
        const stages = [
            { id: 'stage_1_signup', labelKey: 'flow_step_1_short' }, 
            { id: 'stage_2_select', labelKey: 'flow_step_2_short' }, 
            { id: 'stage_3_upload', labelKey: 'flow_step_3_short' }, 
            { id: 'stage_4_diagnosis', labelKey: 'flow_step_4_short' }, 
            { id: 'stage_5_treatment', labelKey: 'flow_step_5_short' } 
        ];

        // Set the current phase the client is in (0-indexed)
        const currentPhaseIndex = 1; 
        const monthsCompleted = 6;
        const totalPrescriptionMonths = 24;
        const percentageCompleted = Math.round((monthsCompleted / totalPrescriptionMonths) * 100);

        // --- Core Translation Function ---
        function updateText() {
            const langData = translations[currentLang];
            
            // 1. Update elements with data-key attribute
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.getAttribute('data-key');
                if (langData[key]) {
                    element.textContent = langData[key];
                }
            });

            // 2. Update dynamic texts
            const remainingMonths = totalPrescriptionMonths - monthsCompleted;
            const remainingText = langData.app_remaining_time.replace('[N]', remainingMonths);

            document.getElementById('appliance-progress-bar-detail').style.width = `${percentageCompleted}%`;
            document.getElementById('appliance-percentage').textContent = `${percentageCompleted}%`;
            document.getElementById('appliance-remaining-months').textContent = remainingMonths;

            document.getElementById('app_duration_text').textContent = langData.app_duration_text;
            document.getElementById('app_remaining_time').textContent = remainingText;
            
            // 3. Update Journey Pipeline
            renderPipeline();

            // 4. Update HTML lang attribute and toggle
            document.getElementById('lang-toggle').textContent = langData.toggle_text;
            document.documentElement.setAttribute('lang', currentLang);
            document.title = langData.header_title;
            
            // 5. Update Appliance Section (Mock current status based on slider)
            const initialMonth = document.getElementById('appliance-timeline-slider').value;
            updateApplianceDetails(initialMonth); 
        }

        // --- Journey Pipeline Renderer ---
        function renderPipeline() {
            const container = document.getElementById('pipeline-container');
            const currentStageDisplay = document.getElementById('current-stage-display');
            const nextActionButton = document.getElementById('next-action-button');
            const langData = translations[currentLang];
            
            // Calculate progress percentage for the bar
            const stageCount = stages.length;
            const progressPercent = (currentPhaseIndex / (stageCount - 1)) * 100;
            document.getElementById('pipeline-progress-bar').style.width = `${progressPercent}%`;

            // Determine the current stage text and next actionable step
            const currentStage = stages[currentPhaseIndex];
            const nextStage = stages[currentPhaseIndex + 1];

            currentStageDisplay.textContent = langData[currentStage.labelKey];

            if (nextStage) {
                 nextActionButton.textContent = langData[nextStage.labelKey];
                 nextActionButton.onclick = () => { switchTab('diagnostics'); alert(langData.next_action_button + ': ' + langData[nextStage.labelKey]); };
            } else {
                 nextActionButton.textContent = langData.flow_step_5_short;
                 nextActionButton.onclick = () => { switchTab('my-plan'); alert(langData.flow_step_5_short); };
            }
            

            container.innerHTML = stages.map((stage, index) => {
                let statusClass = index < currentPhaseIndex ? 'complete' : (index === currentPhaseIndex ? 'current' : 'pending');
                
                const style = index > 0 && index < stageCount - 1 ? 'w-full' : 'w-auto';

                return `
                    <div class="pipeline-stage z-10 ${style}">
                        <div class="pipeline-dot ${statusClass}"></div>
                        <p class="text-xs mt-2 text-center ${index === currentPhaseIndex ? 'font-bold text-sky-700' : 'text-gray-500'}">
                           ${langData[stage.labelKey]}
                        </p>
                    </div>
                `;
            }).join('');
        }

        // --- Appliance Detail Update (Improved UX with Slider) ---
        function updateApplianceDetails(monthValue) {
            const month = parseInt(monthValue);
            const langData = translations[currentLang];
            const adjSetting = document.getElementById('adj-setting-value');
            const adjDate = document.getElementById('adj-date-value');
            const adjNoteContentEl = document.getElementById('adj-note-label'); // Element for appliance note
            const dentistNoteTitleEl = document.getElementById('dentist-note-title'); // Element for dentist note title
            const dentistNoteContentEl = document.getElementById('dentist-note-content'); // Element for dentist note content
            const displayMonth = document.getElementById('display-month');
            
            // 1. Safety check: prevent sliding past current completed month
            if (month > monthsCompleted) {
                document.getElementById('appliance-timeline-slider').value = monthsCompleted;
                return;
            }
            
            // 2. Update Display Month Title
            const timelineTitle = langData.adjustment_timeline_title.replace('[M]', month);
            document.querySelector('[data-key="adjustment_timeline_title"]').textContent = timelineTitle;
            displayMonth.textContent = month;

            // 3. Find historical state
            let state = applianceAdjustments
                .filter(adj => adj.month <= month)
                .sort((a, b) => b.month - a.month)[0];

            // 4. Update Appliance Status (Setting + Date)
            if (state) {
                adjSetting.textContent = state.expansion;
                adjDate.textContent = state.date;
                adjNoteContentEl.textContent = langData.adj_note_label + ': ' + langData[state.noteKey];
                
                // 5. Update Dentist Note based on historical state
                dentistNoteTitleEl.textContent = langData.dentist_note_title.replace('([D])', `(${state.clinicalDate})`);
                dentistNoteContentEl.textContent = langData[state.clinicalNoteKey] || langData.dentist_note_content;

            } else {
                 // Fallback for Month 0/Initial
                adjSetting.textContent = langData.state_m0_set;
                adjDate.textContent = 'N/A';
                adjNoteContentEl.textContent = langData.adj_note_label + ': ' + langData.note_m0;
                
                dentistNoteTitleEl.textContent = langData.dentist_note_title.replace('([D])', `(2025/09/20)`);
                dentistNoteContentEl.textContent = langData.note_clinical_m0;
            }
        }
        
        // --- Language Toggle ---
        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'zh' : 'en';
            updateText();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            const activeContent = document.getElementById('tab-' + tabId);
            if (activeContent) {
                activeContent.classList.remove('hidden');
            }
            const activeButton = document.querySelector(`[onclick="switchTab('${tabId}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        // Placeholder for compatibility (not needed for current scope)
        const updateComparisonView = () => {};
        
        // Initialize the page on load
        document.addEventListener('DOMContentLoaded', () => {
            switchTab('my-plan'); 
            updateText();
        });
    </script>
</body>
</html>
