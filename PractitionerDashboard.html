<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMD Practitioner Dashboard | Case Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .bg-teal-gradient {
            background-image: linear-gradient(to right, #0d9488, #059669); /* Teal 700 to 600 */
        }
        .section-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .nav-button {
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #4b5563;
            border-radius: 0.5rem;
            transition: all 0.15s ease;
        }
        .nav-button.active {
            background-color: #e6fffa; /* Teal 100 */
            color: #0d9488; /* Teal 700 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border-right: 3px solid #0d9488;
        }
        .nav-button:not(.active):hover {
            background-color: #f0fdfa;
        }
        .alert-red {
            background-color: #fef2f2;
            border-left: 4px solid #ef4444;
            color: #b91c1c;
        }
        .chat-practitioner {
            background-color: #ecfdf5; /* Teal 100 */
            align-self: flex-end;
        }
        .chat-client {
            background-color: #dbeafe; /* Blue 100 */
            align-self: flex-start;
        }
        .chat-amc {
            background-color: #f3e8ff; /* Indigo 100 */
            align-self: flex-start;
        }
        .revenue-metric {
            @apply text-xl font-bold text-green-700;
        }
    </style>
</head>
<body>

    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-teal-gradient shadow-md">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                 <h1 id="header-title" class="text-3xl font-bold text-white" data-key="header_title">AMD Practitioner Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <!-- Language Toggle Button (FIXED) -->
                    <button id="lang-toggle" onclick="toggleLanguage()" class="py-1 px-3 rounded-full bg-white text-teal-700 border border-teal-500 hover:bg-teal-100 transition duration-150 font-semibold text-sm shadow">
                        <!-- Text updated by JavaScript -->
                    </button>
                    <a href="index.html" class="text-sm font-medium text-teal-200 hover:text-white" data-key="logout_link">← Log Out / Portal</a>
                </div>
            </div>
        </header>

        <!-- Main Content Area with Navigation Panes -->
        <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <div class="lg:grid lg:grid-cols-4 lg:gap-8">
                
                <!-- LEFT COLUMN: Navigation Tabs (Fixed) -->
                <div class="lg:col-span-1 mb-8 lg:mb-0">
                    <div class="bg-white p-4 rounded-xl shadow-lg lg:sticky lg:top-8">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 border-b pb-2" data-key="nav_practitioner_title">Practice Navigation</h3>
                        <nav class="flex flex-col space-y-2">
                            <button id="nav-overview-btn" class="nav-button active" onclick="switchMainPane('overview')" data-key="nav_overview">
                                Practice Overview
                            </button>
                            <button class="nav-button" onclick="switchMainPane('patients')" data-key="nav_patients">
                                Patient Management
                            </button>
                            <button class="nav-button" onclick="switchMainPane('intake')" data-key="nav_intake">
                                New Patient Intake (3)
                            </button>
                            <button class="nav-button" onclick="switchMainPane('payments')" data-key="nav_payments">
                                Payments & Accounting
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- RIGHT COLUMNS (3/4): Dynamic Content Area -->
                <div id="content-area" class="lg:col-span-3 space-y-8">
                    
                    <!-- 1. Practice Overview (Default Pane) -->
                    <div id="pane-overview" class="main-pane">
                        <h2 class="text-3xl font-bold text-teal-600 mb-6" data-key="overview_summary_title">Practice Summary & Metrics</h2>

                        <!-- Practice Statistics -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="section-card border-l-4 border-teal-500">
                                <p class="text-sm text-gray-500" data-key="stat_active">Active Patients</p>
                                <p class="text-4xl font-bold text-gray-900 mt-1">45</p>
                            </div>
                            <div class="section-card border-l-4 border-amber-500">
                                <p class="text-sm text-gray-500" data-key="stat_new">New Intake (30 days)</p>
                                <p class="text-4xl font-bold text-gray-900 mt-1">8</p>
                            </div>
                            <div class="section-card border-l-4 border-sky-500">
                                <p class="text-sm text-gray-500" data-key="stat_total_seen">Total Patients Seen (Historical)</p>
                                <p class="text-4xl font-bold text-gray-900 mt-1">128</p>
                            </div>
                        </div>

                        <!-- Current Patient Load & Status -->
                        <div class="section-card">
                            <h3 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-key="status_load_title">Current Patient Load & Next Steps</h3>
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="col_patient">Patient</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="col_next_app">Next Appt.</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="col_status">Treatment Status</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="col_specialist">Specialist Review</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                    <tr onclick="selectPatient('Jane Chen')" class="hover:bg-teal-50 cursor-pointer">
                                        <td class="px-3 py-4 font-medium text-gray-900">Jane Chen (ID: 4892)</td>
                                        <td class="px-3 py-4 text-teal-600 font-medium">Today, 2:00 PM</td>
                                        <td class="px-3 py-4"><span class="text-xs font-semibold bg-sky-100 text-sky-800 p-1 rounded">Active Treatment (M6)</span></td>
                                        <td class="px-3 py-4"><span class="text-xs font-medium text-green-600">Complete (Opinion Filed)</span></td>
                                    </tr>
                                    <tr onclick="selectPatient('David Lee')" class="hover:bg-teal-50 cursor-pointer">
                                        <td class="px-3 py-4 font-medium text-gray-900">David Lee (ID: 9011)</td>
                                        <td class="px-3 py-4 text-amber-600">Pending Scheduling</td>
                                        <td class="px-3 py-4"><span class="text-xs font-semibold bg-yellow-100 text-yellow-800 p-1 rounded">Awaiting Scans</span></td>
                                        <td class="px-3 py-4"><span class="text-xs text-gray-500">N/A</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 2. Patient Management (List Pane) -->
                    <div id="pane-patients" class="main-pane hidden">
                         <h2 class="text-3xl font-bold text-teal-600 mb-6" data-key="patient_management_title">Patient Management</h2>
                         <!-- Client Search and Selection -->
                         <div class="section-card mb-4">
                             <div class="flex flex-col md:flex-row gap-4 items-center">
                                 <input type="text" id="patient-search" placeholder="Search by Name, DOB, or Phone Number..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                 <button onclick="mockSearchPatients()" class="py-3 px-6 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 w-full md:w-auto" data-key="btn_search">
                                     Search Clients
                                 </button>
                             </div>
                         </div>
                         <!-- Full Patient List Mock (similar to overview list) -->
                         <div id="full-patient-list" class="section-card">
                             <ul class="divide-y divide-gray-200">
                                 <li onclick="selectPatient('Jane Chen')" class="p-3 hover:bg-teal-50 cursor-pointer flex justify-between items-center">
                                     <span class="font-medium">Jane Chen (ID: 4892)</span>
                                     <span class="text-sm text-sky-600" data-key="btn_view_file">View Full File →</span>
                                 </li>
                                  <li onclick="selectPatient('David Lee')" class="p-3 hover:bg-teal-50 cursor-pointer flex justify-between items-center">
                                     <span class="font-medium">David Lee (ID: 9011)</span>
                                     <span class="text-sm text-sky-600" data-key="btn_view_file">View Full File →</span>
                                 </li>
                             </ul>
                         </div>
                    </div>

                    <!-- 3. New Patient Intake (Intake Pane) -->
                    <div id="pane-intake" class="main-pane hidden">
                        <h2 class="text-3xl font-bold text-teal-600 mb-6" data-key="intake_title">New Patient Intake Review</h2>
                        <div class="section-card">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2" data-key="intake_pending">3 Pending Case Assignments</h3>

                            <!-- Intake Mockup -->
                            <div class="space-y-4 divide-y divide-gray-200">
                                <div class="pt-3 flex justify-between items-center">
                                    <div>
                                        <p class="font-bold text-gray-900">Patient: A. Wong (ID: 1050)</p>
                                        <p class="text-sm text-gray-500" data-key="intake_date">Submitted Assessment: 2025/12/12</p>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="acceptPatient('1050')" class="py-1 px-3 bg-green-500 text-white text-sm rounded-lg" data-key="btn_accept">Accept Patient</button>
                                        <button onclick="rejectPatient('1050')" class="py-1 px-3 bg-red-500 text-white text-sm rounded-lg" data-key="btn_reject">Reject</button>
                                    </div>
                                </div>
                                <div class="pt-3 flex justify-between items-center">
                                    <div>
                                        <p class="font-bold text-gray-900">Patient: B. Liu (ID: 1051)</p>
                                        <p class="text-sm text-gray-500" data-key="intake_date">Submitted Assessment: 2025/12/10</p>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="acceptPatient('1051')" class="py-1 px-3 bg-green-500 text-white text-sm rounded-lg" data-key="btn_accept">Accept Patient</button>
                                        <button onclick="rejectPatient('1051')" class="py-1 px-3 bg-red-500 text-white text-sm rounded-lg" data-key="btn_reject">Reject</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Payments & Accounting Pane (NEW) -->
                    <div id="pane-payments" class="main-pane hidden">
                        <h2 class="text-3xl font-bold text-teal-600 mb-6" data-key="payments_title">Payments & Accounting</h2>
                        <div class="section-card mb-8">
                            <h3 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-key="revenue_summary_title">Revenue Summary (YTD)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="p-3 border rounded-lg bg-green-50">
                                    <p class="text-sm text-gray-500" data-key="total_revenue">Total AMD Revenue</p>
                                    <p class="revenue-metric mt-1">NT$ 1,540,000</p>
                                </div>
                                <div class="p-3 border rounded-lg bg-blue-50">
                                    <p class="text-sm text-gray-500" data-key="appliance_revenue">Appliance Revenue</p>
                                    <p class="revenue-metric mt-1">NT$ 980,000</p>
                                </div>
                                <div class="p-3 border rounded-lg bg-amber-50">
                                    <p class="text-sm text-gray-500" data-key="consultation_revenue">Consultation/Visit Revenue</p>
                                    <p class="revenue-metric mt-1">NT$ 560,000</p>
                                </div>
                            </div>
                        </div>

                        <!-- Patient Financial Breakdown -->
                        <div class="section-card">
                            <h3 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-key="financial_breakdown_title">Patient Financial Breakdown</h3>
                             <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="col_financial_patient">Patient</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="col_visits">Clinical Visits</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="col_treatment_stage">Treatment Stage</th>
                                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="col_revenue">Revenue to Date</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                    <tr class="hover:bg-green-50/50 cursor-pointer">
                                        <td class="px-3 py-4 font-medium text-gray-900">Jane Chen (ID: 4892)</td>
                                        <td class="px-3 py-4">6</td>
                                        <td class="px-3 py-4"><span class="text-xs font-semibold bg-sky-100 text-sky-800 p-1 rounded">Active Treatment (M6)</span></td>
                                        <td class="px-3 py-4 text-right revenue-metric">NT$ 75,000</td>
                                    </tr>
                                    <tr class="hover:bg-green-50/50 cursor-pointer">
                                        <td class="px-3 py-4 font-medium text-gray-900">David Lee (ID: 9011)</td>
                                        <td class="px-3 py-4">1</td>
                                        <td class="px-3 py-4"><span class="text-xs font-semibold bg-yellow-100 text-yellow-800 p-1 rounded">Awaiting Scans</span></td>
                                        <td class="px-3 py-4 text-right revenue-metric">NT$ 3,000</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 5. Client Detail View (Full File: Hidden Pane, mirrored from client dashboard) -->
                    <div id="pane-client-detail" class="main-pane hidden space-y-8">
                        <button onclick="switchMainPane('patients')" class="text-teal-600 font-medium text-sm mb-4 flex items-center">
                             &larr; <span data-key="btn_back_to_list">Back to Patient List</span>
                        </button>
                        
                        <h2 id="client-detail-name" class="text-3xl font-bold text-gray-900 mb-6">Jane Chen's Full File</h2>
                        
                        <!-- Client Dashboard Tabs (Replicating Client Dashboard Structure) -->
                        <div class="lg:grid lg:grid-cols-4 lg:gap-8">
                             <!-- LEFT NAV BAR FOR CLIENT FILE -->
                            <div class="lg:col-span-1 mb-8 lg:mb-0">
                                <div class="bg-white p-4 rounded-xl shadow-lg">
                                    <h3 class="text-lg font-bold text-gray-900 mb-4 border-b pb-2" data-key="nav_client_title">Client File Navigation</h3>
                                    <nav class="flex flex-col space-y-2">
                                        <button class="nav-button active" onclick="switchClientDetailTab('client-plan')" data-key="client_tab_plan">My Plan & Support</button>
                                        <button class="nav-button" onclick="switchClientDetailTab('client-diagnostics')" data-key="client_tab_diagnostics">Scans, Analysis & Reports</button>
                                        <button class="nav-button" onclick="switchClientDetailTab('client-progress')" data-key="client_tab_progress">Progress Tracker</button>
                                        <button class="nav-button" onclick="switchClientDetailTab('client-chat')" data-key="client_tab_chat">Secure Group Chat</button>
                                    </nav>
                                    <button onclick="requestConsultation()" class="mt-6 py-2 px-4 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition duration-150 w-full" data-key="btn_consult_detail">
                                        Request Specialist Consultation
                                    </button>
                                </div>
                            </div>
                            
                            <!-- RIGHT CONTENT FOR CLIENT FILE -->
                            <div id="client-detail-content" class="lg:col-span-3 space-y-8">
                                <!-- Default Client Plan Mock -->
                                <div id="client-tab-client-plan" class="client-detail-tab">
                                    <div class="section-card"><h3 class="font-bold text-xl text-sky-600">Goals & Pains</h3><p class="text-sm mt-2">Client wants to eliminate: Daytime Fatigue, Neck Tension, Dry Mouth. (Data mirrored from ClientDashboard)</p></div>
                                    <div class="section-card"><h3 class="font-bold text-xl text-yellow-600">Appliance & Nutrition</h3><p class="text-sm mt-2">Appliance Setting: 2.0 Turns (M6). Nutrition: Bone Broth, Vitamin D3. (Data mirrored from ClientDashboard)</p></div>
                                </div>
                                
                                <!-- Client Diagnostics Mock -->
                                <div id="client-tab-client-diagnostics" class="client-detail-tab hidden">
                                    <div class="section-card"><h3 class="font-bold text-xl text-indigo-600">CBCT & Analysis</h3><p class="text-sm mt-2">CBCT MCS: 285 mm² (Critical). Schwarz Analysis Ready. (Data mirrored from ClientDashboard)</p></div>
                                </div>

                                <!-- Client Progress Mock -->
                                <div id="client-tab-client-progress" class="client-detail-tab hidden">
                                    <div class="section-card"><h3 class="font-bold text-xl text-sky-600">Photo Timeline</h3><p class="text-sm mt-2">Historical photo viewing and metrics (Jaw Width, Airway Patency). (Data mirrored from ClientDashboard)</p></div>
                                </div>
                                
                                <!-- Client Chat Mock -->
                                <div id="client-tab-client-chat" class="client-detail-tab hidden">
                                    <div class="section-card"><h3 class="font-bold text-xl text-blue-600">Secure Client Chat History</h3><p class="text-sm mt-2">History of communication between Client, AMC, and Dentist. (Data mirrored from ClientDashboard)</p></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- PDPA Confirmation Modal (Unchanged) -->
    <div id="pdpa-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <!-- Modal Content -->
        <div id="pdpa-modal-content" class="bg-white w-full max-w-lg p-8 rounded-xl shadow-2xl relative">
            <h3 class="text-2xl font-bold text-red-600 mb-4 border-b pb-2" data-key="modal_title">Specialist Consultation Request</h3>
            
            <p class="text-lg text-gray-800 mb-6" data-key="modal_subtitle">You are about to share client data with an external consultant.</p>

            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6 rounded-lg">
                <p class="font-semibold text-yellow-800 mb-2" data-key="compliance_check">Compliance Check Required (PDPA/DPA):</p>
                <ul class="list-disc list-inside space-y-2 text-sm text-gray-700">
                    <li data-key="pdpa_1"><strong class="text-red-600">(1) Written Consent:</strong> Confirm written consent is obtained from the patient.</li>
                    <li data-key="pdpa_2"><strong class="text-red-600">(2) Data Processing Agreement (DPA):</strong> Confirm DPA is in place with the consultant.</li>
                    <li data-key="pdpa_3"><strong class="text-red-600">(3) Pseudonymization:</strong> Ensure data shared is pseudonymized to prevent direct identification.</li>
                </ul>
            </div>

            <p class="text-sm text-gray-600 mb-6" data-key="modal_confirmation">By proceeding, you confirm all three compliance points have been met for sharing <span id="consult-client-name" class="font-bold text-gray-900"></span>'s data.</p>

            <div class="flex justify-end space-x-4">
                <button onclick="closeModal('pdpa-modal')" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400" data-key="btn_cancel">Cancel</button>
                <button onclick="confirmConsultation()" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold" data-key="btn_confirm_share">Confirm & Share Data</button>
            </div>
        </div>
    </div>
    
    <!-- JavaScript for Functionality and Translations -->
    <script>
        // --- Global State & Constants ---
        let currentClient = null;
        let currentPane = 'overview';
        let currentClientTab = 'client-plan';
        
        let currentLang = 'en';

        // Mock Patient Data (for dynamic population in client detail view)
        const mockPatients = {
            'Jane Chen': { id: '4892', nextAppt: 'Today, 2:00 PM', goals: 'Fatigue, Tension', implantStatus: 'M6' },
            'David Lee': { id: '9011', nextAppt: 'Pending Scheduling', goals: 'Snoring, Dry Mouth', implantStatus: 'Awaiting Scans' }
        };
        
        // --- PDPA Modal Logic (Unchanged but nested) ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            const modalContent = document.getElementById(modalId + '-content');

            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('modal-fade-enter');
                modalContent.classList.add('modal-fade-enter-active');
            }, 10); 
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            const modalContent = document.getElementById(modalId + '-content');
            
            if (!modal || !modalContent) return;

            modalContent.classList.remove('modal-fade-enter-active');
            modalContent.classList.add('modal-fade-enter');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }
        
        function requestConsultation() {
            if (!currentClient) {
                alert(translations[currentLang].search_title + ' ' + (currentLang === 'en' ? 'first.' : 'first.'));
                return;
            }
            document.getElementById('consult-client-name').textContent = currentClient.name;
            openModal('pdpa-modal');
            updateText(); // Re-render modal text with the client name
        }

        function confirmConsultation() {
            closeModal('pdpa-modal');
            const message = currentLang === 'en' ? 
                `Client ${currentClient.name}'s data has been pseudonymized and shared with the professional consultant. Compliance confirmed.` :
                `Client ${currentClient.name}'s data has been pseudonymized and shared with the professional consultant. Compliance confirmed.`;
            alert(message);
        }

        // --- Core Dashboard Navigation Logic ---
        
        function switchMainPane(paneId) {
            currentPane = paneId;
            
            document.querySelectorAll('.main-pane').forEach(pane => {
                pane.classList.add('hidden');
            });
            document.getElementById(`pane-${paneId}`).classList.remove('hidden');

            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`[onclick="switchMainPane('${paneId}')"]`).classList.add('active');

            if (paneId === 'overview') {
                 currentClient = null; // Clear client selection when returning to overview
            }
        }
        
        function switchClientDetailTab(tabId) {
            currentClientTab = tabId;
            
            document.querySelectorAll('.client-detail-tab').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.getElementById(`client-tab-${tabId}`).classList.remove('hidden');

            document.querySelectorAll('.nav-button').forEach(button => {
                 button.classList.remove('active');
            });
            document.querySelector(`[onclick="switchClientDetailTab('${tabId}')"]`).classList.add('active');
        }


        function selectPatient(name) {
            currentClient = mockPatients[name];
            currentClient.name = name;
            
            document.getElementById('client-detail-name').textContent = `${name}'s Full File (ID: ${currentClient.id})`;
            
            // Switch to the Client Detail Pane
            switchMainPane('client-detail');
            switchClientDetailTab('client-plan');
            
            // Update data within the client detail view (mock content update)
            // Note: In a real app, this would trigger fetching the client's full diagnostics, goals, etc.
        }
        
        function mockSearchPatients() {
             // Mock search logic here
             alert('Simulating search...');
        }
        
        function acceptPatient(id) {
            alert(translations[currentLang].btn_accept + ` patient ID ${id}. Sending welcome packet.`);
        }

        function rejectPatient(id) {
            const reason = prompt(translations[currentLang].reject_reason_prompt || "Reason for rejection:");
            if (reason) {
                alert(`Rejecting patient ID ${id}. Reason: ${reason}`);
            }
        }
        
        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'zh' : 'en';
            updateText();
        }

        // --- Utility/Rendering Functions ---
        
        function setupDiagnosticHistorySelectors() {
            const langData = translations[currentLang];

            // Re-render selectors (Implementation omitted for brevity, logic remains same)
        }

        function updateDiagnosticContent(type, id) {
             // Logic for dynamic content update (Implementation omitted for brevity, logic remains same)
        }

        function updateApplianceDetails(monthValue) {
            const month = parseInt(monthValue);
            const langData = translations[currentLang];
            const adjSetting = document.getElementById('adj-setting-value');
            const adjDate = document.getElementById('adj-date-value');
            const adjNoteContentEl = document.getElementById('adj-note-label'); 
            const dentistNoteTitleEl = document.getElementById('dentist-note-title'); 
            const dentistNoteContentEl = document.getElementById('dentist-note-content'); 
            const displayMonth = document.getElementById('display-month');
            
            if (month > monthsCompleted) {
                document.getElementById('appliance-timeline-slider').value = monthsCompleted;
                return;
            }
            
            const timelineTitle = langData.adjustment_timeline_title.replace('[M]', month);
            document.querySelector('[data-key="adjustment_timeline_title"]').textContent = timelineTitle;
            displayMonth.textContent = month;

            let state = applianceAdjustments
                .filter(adj => adj.month <= month)
                .sort((a, b) => b.month - a.month)[0];

            if (state) {
                adjSetting.textContent = state.expansion;
                adjDate.textContent = state.date;
                adjNoteContentEl.textContent = langData.adj_note_label + ': ' + langData[state.noteKey];
                
                dentistNoteTitleEl.textContent = langData.dentist_note_title.replace('[D]', state.clinicalDate);
                dentistNoteContentEl.textContent = langData[state.clinicalNoteKey] || langData.dentist_note_content;

            } else {
                adjSetting.textContent = langData.state_m0_set;
                adjDate.textContent = 'N/A';
                adjNoteContentEl.textContent = langData.adj_note_label + ': ' + langData.note_m0;
                
                dentistNoteTitleEl.textContent = langData.dentist_note_title.replace('[D]', `2025/09/20`);
                dentistNoteContentEl.textContent = langData.note_clinical_m0;
            }
        }

        function updateComparisonView() {
            // Placeholder for compatibility
        }

        function updateText() {
            const langData = translations[currentLang];
            
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.getAttribute('data-key');
                if (langData[key]) {
                    element.textContent = langData[key];
                }
            });

            const remainingMonths = totalPrescriptionMonths - monthsCompleted;
            const remainingText = langData.app_remaining_time.replace('[N]', remainingMonths);

            // Update main status metrics
            document.getElementById('appliance-progress-bar-detail').style.width = `${percentageCompleted}%`;
            document.getElementById('appliance-percentage').textContent = `${percentageCompleted}%`;
            document.getElementById('appliance-remaining-months').textContent = remainingMonths;

            document.getElementById('app_duration_text').textContent = langData.app_duration_text;
            document.getElementById('app_remaining_time').textContent = remainingText;
            
            // Re-initialize dynamic components
            // setupDiagnosticHistorySelectors(); 
            
            if (document.getElementById('appliance-timeline-slider')) {
                const initialMonth = document.getElementById('appliance-timeline-slider').value;
                updateApplianceDetails(initialMonth); 
            }

            document.getElementById('lang-toggle').textContent = langData.toggle_text;
            document.documentElement.setAttribute('lang', currentLang);
            document.title = langData.header_title;
        }
        
        // --- Translation Data Structure (Defined after functions for scope clarity) ---
        const translations = {
            'en': {
                'header_title': 'AMD Practitioner Dashboard',
                'logout_link': '← Log Out / Portal',
                'nav_practitioner_title': 'Practice Navigation',
                'nav_overview': 'Practice Overview',
                'nav_patients': 'Patient Management',
                'nav_intake': 'New Patient Intake (3)',
                'nav_payments': 'Payments & Accounting', // NEW
                'overview_summary_title': 'Practice Summary & Metrics',
                'stat_active': 'Active Patients',
                'stat_new': 'New Intake (30 days)',
                'stat_total_seen': 'Total Patients Seen (Historical)',
                'col_patient': 'Patient',
                'col_next_app': 'Next Appt.',
                'col_status': 'Treatment Status',
                'col_specialist': 'Specialist Review',
                'status_load_title': 'Current Patient Load & Next Steps',
                'patient_management_title': 'Patient Management',
                'btn_search': 'Search Clients',
                'btn_view_file': 'View Full File →',
                'btn_back_to_list': 'Back to Patient List',
                'client_tab_plan': 'My Plan & Support',
                'client_tab_diagnostics': 'Scans, Analysis & Reports',
                'client_tab_progress': 'Progress Tracker',
                'client_tab_chat': 'Secure Group Chat',
                'btn_consult_detail': 'Request Specialist Consultation',
                'intake_title': 'New Patient Intake Review',
                'intake_pending': 'Pending Case Assignments',
                'intake_date': 'Submitted Assessment:',
                'btn_accept': 'Accept Patient',
                'btn_reject': 'Reject',
                'chat_title': 'Clinic Group Chat',
                'chat_subtitle': 'Secure communication with AMC, Specialists, and internal staff.',
                'msg_practitioner': 'You (Dr. Smith)',
                'msg_p_text': 'Please verify if the INV file for Jane Chen (4892) was successfully shared with Dr. Felix.',
                'msg_amc': 'Jane Chen (AMC)',
                'msg_a_text': 'Confirmed. DPA compliance checked and file uploaded securely at 10:15 AM.',
                'btn_send': 'Send',
                'expert_feedback_title': 'Expert Consultation Feedback',
                'expert_feedback_date': 'Last Updated:',
                'expert_feedback_summary': 'Recommendation: Maintain current expansion rate for 3 months, reassess CBCT at month 9.',
                'goals_pains_title': 'Client Goals & Pains',
                'symptoms_title': 'Symptoms to Eliminate:',
                'conditions_title': 'Existing Pains/Conditions:',
                'interventions_title': 'Treatment Interventions',
                'appliance_name': 'Start Thriving Appliance (TM)',
                'nutrition_focus': 'Prescribed Nutrition Focus:',
                'amc_support_title': 'AMC & Support',
                'amc_coordinator_title': 'Assigned Coordinator: Jane Chen (AMC)',
                'amc_session': 'Current Coaching Session:',
                'diagnostics_title': 'AMD Diagnostic Inputs',
                'cbct_title': 'CB CT Scan (Airway)',
                'mcs_value_status': 'MCS: 285 mm² (Critical!)',
                'intraoral_title': '3D Intra-Oral Scan (Teeth)',
                'ceph_title': 'Ceph Flow Metric Analysis',
                'reject_reason_prompt': 'Please enter the reason for rejection:',
                'patient_name_label': 'Patient:',
                'patient_id_label': 'Patient ID:',
                'dentist_label': 'Dentist:',
                'amc_label': 'AMC:',
                'key_contacts_title': 'Key Contacts & Appointments',
                'next_appointment_label': 'Next Appointment:',
                'btn_create_appointment': 'Create New Appointment',
                'toggle_text': '中文',
                'journey_title': 'My Journey',
                'sec_goals_title_impact': 'Goals & Motivation',
                'goals_motivation_intro': 'Focus on these goals—they are the powerful symptoms we are working together to eliminate through holistic treatment.',
                'goals_list_title': 'My 3 Symptoms to Eliminate:',
                'goal1': 'Chronic Daytime Fatigue',
                'goal2': 'Frequent Neck/Shoulder Tension',
                'goal3': 'Waking up with dry mouth',
                'btn_update_goals': 'Update Pains & Goals',
                
                'payments_title': 'Payments & Accounting', // NEW
                'revenue_summary_title': 'Revenue Summary (YTD)', // NEW
                'total_revenue': 'Total AMD Revenue', // NEW
                'appliance_revenue': 'Appliance Revenue', // NEW
                'consultation_revenue': 'Consultation/Visit Revenue', // NEW
                'financial_breakdown_title': 'Patient Financial Breakdown', // NEW
                'col_financial_patient': 'Patient', // NEW
                'col_visits': 'Clinical Visits', // NEW
                'col_treatment_stage': 'Treatment Stage', // NEW
                'col_revenue': 'Revenue to Date', // NEW
                'metric_jaw_size': 'Jaw Width Increase (Intermolar):', // FROM CLIENT
                'metric_start_target': 'Start: 40.0mm | Target: 45.0mm', // FROM CLIENT
                'metric_airway': 'Airway Patency (MCS):', // FROM CLIENT
                'metric_start_target_airway': 'Start: 285 mm² | Target: >320 mm²', // FROM CLIENT
                'metric_sleep_score': 'Sleep Symptom Score (MSQ):', // FROM CLIENT
                'score_change_text': '(↓ -7)', // FROM CLIENT
                'metric_start_target_sleep': 'Start: 25 | Target: < 5', // FROM CLIENT
                'cbct_history_label': 'View Historical Scan Data:', 
                'analysis_history_label': 'View Historical Analysis:',
                'scan_date_0': '2025/12/10 (Initial)',
                'scan_date_1': '2026/03/10 (Month 3 Follow-up)',
                'analysis_date_0': '2025/12/10 (Baseline)',
                'analysis_date_1': '2026/06/10 (Mid-Treatment)',
                'schwarz_status': 'Schwarz Analysis Ready',
                'sassouni_status': 'Sassouni Plus Report',
                'btn_view_full_scan': 'View Full Scan / IMS Report',
                'btn_view_analysis_report': 'View Analysis & Report',
                'btn_view_report_angles': 'View Report & Angles'


            },
            'zh': {
                'header_title': 'AMD 執業醫師儀表板',
                'logout_link': '← 登出 / 入口網站',
                'nav_practitioner_title': '診所導航',
                'nav_overview': '實務概覽',
                'nav_patients': '患者管理',
                'nav_intake': '新患者入組 (3)',
                'nav_payments': '支付與會計', // NEW
                'overview_summary_title': '實務摘要與指標',
                'stat_active': '活躍患者',
                'stat_new': '新患者入組 (30 天)',
                'stat_total_seen': '歷史總患者數',
                'col_patient': '患者',
                'col_next_app': '下次預約',
                'col_status': '治療狀態',
                'col_specialist': '專家審閱',
                'status_load_title': '當前患者負載與下一步',
                'patient_management_title': '患者管理',
                'btn_search': '搜尋客戶',
                'btn_view_file': '查看完整檔案 →',
                'btn_back_to_list': '返回患者列表',
                'client_tab_plan': '我的計劃與支持',
                'client_tab_diagnostics': '掃描、分析與報告',
                'client_tab_progress': '進度追踪器',
                'client_tab_chat': '安全群組聊天',
                'btn_consult_detail': '請求專家會診',
                'intake_title': '新患者入組審閱',
                'intake_pending': '待處理病例分配',
                'intake_date': '評估提交日期:',
                'btn_accept': '接受患者',
                'btn_reject': '拒絕',
                'chat_title': '診所群組聊天',
                'chat_subtitle': '與 AMC、專家和內部人員的安全溝通。',
                'msg_practitioner': '您 (Smith 醫生)',
                'msg_p_text': '請驗證 Jane Chen (4892) 的 INV 文件是否已成功分享給 Dr. Felix。',
                'msg_amc': 'Jane Chen (AMC)',
                'msg_a_text': '已確認。DPA 合規性已檢查，文件已於上午 10:15 安全上傳。',
                'btn_send': '發送',
                'expert_feedback_title': '專家會診反饋',
                'expert_feedback_date': '上次更新:',
                'expert_feedback_summary': '建議: 維持當前擴展率 3 個月，在第 9 個月重新評估 CBCT。',
                'goals_pains_title': '客戶目標與疼痛',
                'symptoms_title': '欲消除症狀:',
                'conditions_title': '現有疼痛/狀況:',
                'interventions_title': '治療干預措施',
                'appliance_name': '開始興盛矯治器 (TM)',
                'nutrition_focus': '處方營養重點:',
                'amc_support_title': 'AMC 與支持',
                'amc_coordinator_title': '指定協調員: Jane Chen (AMC)',
                'amc_session': '當前指導課程:',
                'diagnostics_title': 'AMD 診斷輸入',
                'cbct_title': '錐束CT掃描 (氣道)',
                'mcs_value_status': 'MCS: 285 毫米² (危急!)',
                'intraoral_title': '3D 口內掃描 (牙齒)',
                'ceph_title': '頭影流動測量分析',
                'reject_reason_prompt': '請輸入拒絕原因:',
                'patient_name_label': '患者姓名:',
                'patient_id_label': '患者 ID:',
                'dentist_label': '牙醫:',
                'amc_label': 'AMC:',
                'key_contacts_title': '關鍵聯絡人與預約',
                'next_appointment_label': '下次預約:',
                'btn_create_appointment': '創建新預約',
                'toggle_text': 'English',
                'journey_title': '我的旅程',
                'sec_goals_title_impact': '我的旅程：目標與動力',
                'goals_motivation_intro': '專注於這些目標—它們是我們正在通過整體治療共同努力消除的強大症狀。',
                'goals_list_title': '我的 3 個欲消除症狀:',
                'goal1': '慢性白天疲勞',
                'goal2': '頻繁頸部/肩部緊張',
                'goal3': '醒來時口乾',
                'btn_update_goals': '更新疼痛與目標',
                
                'payments_title': '支付與會計', // NEW
                'revenue_summary_title': '營收摘要 (YTD)', // NEW
                'total_revenue': '總 AMD 營收', // NEW
                'appliance_revenue': '矯治器營收', // NEW
                'consultation_revenue': '諮詢/門診營收', // NEW
                'financial_breakdown_title': '患者財務明細', // NEW
                'col_financial_patient': '患者', // NEW
                'col_visits': '門診次數', // NEW
                'col_treatment_stage': '治療階段', // NEW
                'col_revenue': '累計營收', // NEW
                'metric_jaw_size': '下巴寬度增加 (磨牙間):', // FROM CLIENT
                'metric_start_target': '開始: 40.0mm | 目標: 45.0mm', // FROM CLIENT
                'metric_airway': '氣道暢通度 (MCS):', // FROM CLIENT
                'metric_start_target_airway': '開始: 285 mm² | 目標: >320 mm²', // FROM CLIENT
                'metric_sleep_score': '睡眠症狀分數 (MSQ):', // FROM CLIENT
                'score_change_text': '(↓ -7)', // FROM CLIENT
                'metric_start_target_sleep': '開始: 25 | 目標: < 5', // FROM CLIENT
                'cbct_history_label': '查看歷史掃描數據:', 
                'analysis_history_label': '查看歷史分析:',
                'scan_date_0': '2025/12/10 (初始)',
                'scan_date_1': '2026/03/10 (第 3 個月追蹤)',
                'analysis_date_0': '2025/12/10 (基線)',
                'analysis_date_1': '2026/06/10 (中期治療)',
                'schwarz_status': 'Schwarz 分析準備就緒',
                'sassouni_status': 'Sassouni Plus 報告',
                'btn_view_full_scan': '查看完整掃描 / IMS 報告',
                'btn_view_analysis_report': '查看分析與報告',
                'btn_view_report_angles': '查看報告與角度'
            }
        };
