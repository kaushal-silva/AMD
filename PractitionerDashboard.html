<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMD Practitioner Dashboard | Case Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .bg-teal-gradient { background-image: linear-gradient(to right, #0d9488, #059669); }
        .section-card { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        
        .nav-button { padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: #64748b; border-radius: 0.5rem; transition: all 0.2s ease; width: 100%; display: flex; align-items: center; gap: 10px; }
        .nav-button:hover { background-color: #f1f5f9; color: #0d9488; }
        .nav-button.active { background-color: #e6fffa; color: #0d9488; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border-right: 3px solid #0d9488; }

        .tracker-header { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; padding: 1rem 0.5rem; border-bottom: 2px solid #f1f5f9; }
        .ageing-pill { font-size: 0.65rem; padding: 0.1rem 0.4rem; border-radius: 4px; font-weight: 700; display: inline-block; }
        .ageing-done { background-color: #f1f5f9; color: #94a3b8; }
        .ageing-active { background-color: #e6fffa; color: #0d9488; border: 1px solid #b2f5ea; }
        .ageing-alert { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        
        .tooltip-container { position: relative; display: inline-block; }
        .tooltip-text { visibility: hidden; width: 220px; background-color: #1e293b; color: #fff; border-radius: 8px; padding: 10px; position: absolute; z-index: 50; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.2s; font-size: 0.75rem; font-weight: 400; line-height: 1.4; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1e293b transparent transparent transparent; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        .sub-nav-btn { padding: 0.6rem 1rem; font-size: 0.8rem; font-weight: 600; color: #64748b; border-radius: 0.5rem; transition: all 0.2s; display: flex; align-items: center; gap: 8px; width: 100%; text-align: left; border-left: 3px solid transparent; }
        .sub-nav-btn:hover { background-color: #f8fafc; color: #0d9488; }
        .sub-nav-btn.active { background-color: #f0fdfa; color: #0d9488; border-left: 3px solid #0d9488; font-weight: 700; }

        .chat-bubble { padding: 0.75rem 1rem; border-radius: 1rem; max-width: 85%; font-size: 0.85rem; line-height: 1.5; margin-bottom: 0.75rem; }
        .chat-amd { background-color: #ecfdf5; align-self: flex-end; border-bottom-right-radius: 0; border: 1px solid #d1fae5; }
        .chat-atc { background-color: #f3e8ff; align-self: flex-start; border-bottom-left-radius: 0; border: 1px solid #e9d5ff; }
        .chat-patient { background-color: #dbeafe; align-self: flex-start; border-bottom-left-radius: 0; border: 1px solid #bfdbfe; }
        .chat-specialist { background-color: #f1f5f9; align-self: flex-start; border-bottom-left-radius: 0; border: 1px solid #cbd5e1; }

        .scan-card { aspect-ratio: 1; background: #f8fafc; border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px dashed #cbd5e1; transition: border-color 0.2s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen">
        <header class="bg-teal-gradient shadow-sm sticky top-0 z-50">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                 <div class="flex items-center gap-3">
                     <!-- SVG Logo -->
                     <svg width="32" height="32" viewBox="0 0 100 100" class="fill-white">
                        <path d="M70,20 C60,10 40,10 30,20 C20,30 15,50 20,65 C22,70 25,75 30,78 C35,82 45,85 55,85 C65,85 75,80 80,70 C85,60 85,30 70,20 Z M50,15 C65,15 75,25 78,40 C80,50 80,65 72,78 C65,85 50,85 40,78 C35,74 30,65 30,50 C30,35 40,15 50,15 Z" opacity="0.4"/>
                        <path d="M45,45 Q50,40 55,45 Q60,50 55,65 Q50,75 45,65 Q40,55 45,45 Z" fill="#b2f5ea"/>
                        <path d="M35,65 Q40,75 55,75 Q70,75 75,65" stroke="white" stroke-width="4" fill="none" stroke-linecap="round"/>
                     </svg>
                     <h1 class="text-xl font-bold text-white tracking-tight" data-key="header_title">AMD Practitioner Dashboard</h1>
                 </div>
                <div class="flex items-center space-x-4">
                    <button id="lang-toggle" onclick="toggleLanguage()" class="py-1.5 px-4 rounded-full bg-white/10 text-white font-semibold text-xs border border-white/20 hover:bg-white/20 transition">中文</button>
                    <div class="h-8 w-8 rounded-full bg-teal-800 flex items-center justify-center text-white text-xs font-bold border border-teal-400">RC</div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <div class="lg:grid lg:grid-cols-4 lg:gap-8">
                
                <div class="lg:col-span-1 mb-8">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 sticky top-24">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 px-2" data-key="nav_group_title">Practice Management</h3>
                        <nav class="flex flex-col space-y-1">
                            <button id="nav-overview" class="nav-button active" onclick="switchMainPane('overview')">
                                <i class="fa-solid fa-chart-line w-4"></i> <span data-key="nav_overview">Overview</span>
                            </button>
                            <button id="nav-patients" class="nav-button" onclick="switchMainPane('patients')">
                                <i class="fa-solid fa-user-group w-4"></i> <span data-key="nav_patients">Patients</span>
                            </button>
                            <button id="nav-intake" class="nav-button" onclick="switchMainPane('intake')">
                                <i class="fa-solid fa-clipboard-list w-4"></i> <span data-key="nav_intake">Intake Queue</span>
                            </button>
                            <button id="nav-payments" class="nav-button" onclick="switchMainPane('payments')">
                                <i class="fa-solid fa-wallet w-4"></i> <span data-key="nav_accounting">Accounting</span>
                            </button>
                        </nav>
                    </div>
                </div>

                <div id="content-area" class="lg:col-span-3">
                    
                    <!-- 1. Overview Pane -->
                    <div id="pane-overview" class="main-pane space-y-6">
                        <h2 class="text-2xl font-black text-slate-800 tracking-tight" data-key="overview_title">Case Pipeline Tracking</h2>
                        <div class="section-card overflow-hidden !p-0 border border-slate-100">
                            <div class="overflow-x-auto no-scrollbar">
                                <table class="min-w-full divide-y divide-slate-100">
                                    <thead class="bg-slate-50/50">
                                        <tr>
                                            <th class="tracker-header text-left pl-6" data-key="col_patient">Patient</th>
                                            <th class="tracker-header text-center" data-key="col_intake">Intake</th>
                                            <th class="tracker-header text-center" data-key="col_diag">Diag</th>
                                            <th class="tracker-header text-center" data-key="col_spec">Spec</th>
                                            <th class="tracker-header text-center" data-key="col_cons">Cons</th>
                                            <th class="tracker-header text-center" data-key="col_mfg">Mfg</th>
                                            <th class="tracker-header text-center" data-key="col_log">Log</th>
                                            <th class="tracker-header text-right pr-6" data-key="col_ageing">Ageing Breakdown</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tracker-body" class="bg-white divide-y divide-slate-100 text-sm"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Patients Pane -->
                    <div id="pane-patients" class="main-pane hidden space-y-6">
                        <h2 class="text-2xl font-black text-slate-800 tracking-tight" data-key="registry_title">Patient Registry</h2>
                        <div class="section-card">
                            <div class="relative mb-6">
                                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                                <input type="text" id="patient-search" onkeyup="filterPatients()" placeholder="Search..." class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                            </div>
                            <div class="overflow-hidden border border-slate-100 rounded-lg">
                                <table class="w-full text-left"><tbody id="patient-list-body" class="divide-y divide-slate-50"></tbody></table>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Detail View -->
                    <div id="pane-client-detail" class="main-pane hidden space-y-6">
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                                <button onclick="switchMainPane('overview')" class="h-10 w-10 rounded-full border border-slate-200 flex items-center justify-center text-slate-400 hover:text-teal-600 transition">
                                    <i class="fa-solid fa-arrow-left"></i>
                                </button>
                                <div>
                                    <h2 id="detail-name" class="text-2xl font-black text-slate-900 leading-none mb-1">--</h2>
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                                        ID: <span id="detail-id" class="text-teal-600 font-mono">--</span> 
                                        <span class="w-1 h-1 rounded-full bg-slate-300"></span> 
                                        Assigned ATC: <span id="detail-atc" class="text-purple-600 font-bold">--</span>
                                    </p>
                                </div>
                            </div>
                            <button onclick="openPDPA()" class="px-5 py-2.5 bg-red-600 text-white text-[10px] font-black rounded-lg uppercase tracking-widest shadow-lg hover:bg-red-700 transition" data-key="btn_refer">Refer to Specialist</button>
                        </div>

                        <div class="flex flex-col md:flex-row gap-6">
                            <div class="md:w-64 flex-shrink-0">
                                <div class="bg-white p-3 rounded-xl border border-slate-100 space-y-1">
                                    <button class="sub-nav-btn active" onclick="switchDetailTab('clinical')"><i class="fa-solid fa-stethoscope w-4"></i> <span data-key="tab_clinical">Clinical Progress</span></button>
                                    <button class="sub-nav-btn" onclick="switchDetailTab('questionnaire')"><i class="fa-solid fa-clipboard-question w-4"></i> <span data-key="tab_questionnaire">Patient Questionnaire</span></button>
                                    <button class="sub-nav-btn" onclick="switchDetailTab('diagnostics')"><i class="fa-solid fa-microscope w-4"></i> <span data-key="tab_diagnostics">Scans, Analysis & Reports</span></button>
                                    <button class="sub-nav-btn" onclick="switchDetailTab('specialist')"><i class="fa-solid fa-user-doctor w-4"></i> <span data-key="tab_consultation">Specialist Consultation</span></button>
                                    <button class="sub-nav-btn" onclick="switchDetailTab('coaching')"><i class="fa-solid fa-video w-4"></i> <span data-key="tab_coaching_hub">Shared Coaching Hub</span></button>
                                    <button class="sub-nav-btn" onclick="switchDetailTab('treatment')"><i class="fa-solid fa-screwdriver-wrench w-4"></i> <span data-key="tab_treatment">Treatment Workspace</span></button>
                                    <button class="sub-nav-btn" onclick="switchDetailTab('chat')"><i class="fa-solid fa-comments w-4"></i> <span data-key="tab_chat">Secure Group Chat</span></button>
                                    <button class="sub-nav-btn" onclick="switchDetailTab('spec-chat')"><i class="fa-solid fa-user-secret w-4"></i> <span data-key="tab_spec_chat">Clinical Collaboration</span></button>
                                    <button class="sub-nav-btn" onclick="switchDetailTab('notes')"><i class="fa-solid fa-pen-to-square w-4"></i> <span data-key="tab_records">Practice Records</span></button>
                                </div>
                            </div>

                            <div class="flex-1 min-w-0">
                                <div id="tab-clinical" class="detail-tab space-y-6">
                                    <div class="section-card">
                                        <div class="flex justify-between items-center mb-6">
                                            <h3 class="font-bold text-slate-800" data-key="granular_status">Granular Workflow Status</h3>
                                            <span class="text-[10px] font-black text-slate-400 uppercase">Total Ageing: <span id="detail-total-ageing" class="text-teal-600">--</span></span>
                                        </div>
                                        <div id="detail-granular-timeline" class="space-y-8"></div>
                                    </div>
                                </div>

                                <!-- Questionnaire Tab -->
                                <div id="tab-questionnaire" class="detail-tab hidden space-y-6">
                                    <div class="section-card bg-teal-50 border border-teal-100">
                                        <h3 class="font-bold text-teal-800 mb-4" data-key="tab_questionnaire">Patient Submitted Questionnaire</h3>
                                        <div class="space-y-4 text-sm text-slate-700">
                                            <div class="bg-white p-3 rounded-lg"><h4 class="font-bold mb-1">Motivations</h4><p id="q-mot">--</p></div>
                                            <div class="bg-white p-3 rounded-lg"><h4 class="font-bold mb-1">Pain Points</h4><p id="q-pain">--</p></div>
                                            <div class="bg-white p-3 rounded-lg"><h4 class="font-bold mb-1">Medical History</h4><p id="q-hist">--</p></div>
                                            <div class="bg-white p-3 rounded-lg"><h4 class="font-bold mb-1">Integrated MSQ Score</h4><p>Head/Neck: 14 | Cardio: 5 | Digestive: 2 | Brain: 18 (Severe)</p></div>
                                        </div>
                                        <button class="mt-4 px-4 py-2 bg-teal-600 text-white text-[10px] font-black rounded uppercase shadow-sm hover:bg-teal-700">Download Full PDF</button>
                                    </div>
                                </div>

                                <!-- Scans, Analysis & Reports (Updated Terminology & Features) -->
                                <div id="tab-diagnostics" class="detail-tab hidden space-y-6">
                                    <div class="section-card">
                                        <h3 class="font-bold text-slate-800 mb-4" data-key="uploaded_diagnostics">Scans, Analysis & Reports</h3>
                                        
                                        <!-- Scans -->
                                        <h4 class="text-[10px] font-black text-slate-400 uppercase mb-2">Clinical Scans</h4>
                                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="detail-scans-list">
                                            <!-- Injected via JS with timestamps -->
                                        </div>
                                        
                                        <!-- Analysis -->
                                        <h4 class="text-[10px] font-black text-slate-400 uppercase mb-2">Expert Analysis</h4>
                                        <div class="p-3 bg-amber-50 border border-amber-100 rounded-lg mb-6">
                                            <p class="text-xs text-amber-800 italic" id="analysis-summary">--</p>
                                        </div>

                                        <!-- Reports -->
                                        <h4 class="text-[10px] font-black text-slate-400 uppercase mb-2">Medical Reports</h4>
                                        <div class="space-y-2">
                                            <div class="p-2 border rounded flex justify-between text-xs bg-slate-50"><span>Blood Panel (CBC) - 2025/11/15</span><button class="text-blue-600 font-bold hover:underline">View</button></div>
                                            <div class="p-2 border rounded flex justify-between text-xs bg-slate-50"><span>Liver Function - 2025/11/15</span><button class="text-blue-600 font-bold hover:underline">View</button></div>
                                            <div class="p-2 border rounded flex justify-between text-xs bg-slate-50"><span>Kidney Function - 2025/11/15</span><button class="text-blue-600 font-bold hover:underline">View</button></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Specialist Tab (Expanded Info) -->
                                <div id="tab-specialist" class="detail-tab hidden space-y-6">
                                    <div class="section-card relative">
                                        <div id="report-locked" class="absolute inset-0 bg-slate-100/80 backdrop-blur-sm flex items-center justify-center z-10 hidden">
                                            <div class="text-center p-6 bg-white rounded-xl shadow border border-slate-200">
                                                <i class="fa-solid fa-lock text-slate-300 text-4xl mb-4"></i>
                                                <h4 class="font-black text-slate-800 uppercase text-xs" data-key="report_locked">Report Not Available</h4>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center mb-6 border-b pb-4">
                                            <h3 class="font-bold text-slate-800" data-key="clinical_design_report">Clinical Design Report</h3>
                                            <button onclick="alert('Downloading...')" class="bg-teal-600 text-white px-3 py-1.5 rounded text-[10px] font-bold uppercase tracking-widest">Download PDF</button>
                                        </div>
                                        <div class="space-y-6">
                                            <!-- Full Prescription Details Visible -->
                                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                                <h4 class="text-[10px] font-black text-teal-600 uppercase mb-2" data-key="notes_for_amd">Notes for AMD</h4>
                                                <p id="consult-notes" class="text-sm text-slate-700 font-medium italic mb-4">--</p>
                                                
                                                <div class="grid grid-cols-2 gap-4 border-t pt-4 mt-2">
                                                    <div>
                                                        <p class="text-[9px] font-black text-slate-400 uppercase">Target Expansion</p>
                                                        <p class="text-sm font-bold text-slate-800" id="consult-target">--</p>
                                                    </div>
                                                    <div>
                                                        <p class="text-[9px] font-black text-slate-400 uppercase">Turn Protocol</p>
                                                        <p class="text-sm font-bold text-slate-800" id="consult-protocol">--</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="p-4 bg-blue-50/50 rounded-xl border border-blue-100">
                                                <h4 class="text-[10px] font-black text-blue-600 uppercase mb-2" data-key="specialist_guidance">Specialist Guidance</h4>
                                                <p id="consult-guidance" class="text-sm text-slate-700 font-bold italic">--</p>
                                            </div>
                                            
                                            <div class="p-4 bg-green-50 rounded-xl border border-green-100">
                                                <h4 class="text-[10px] font-black text-green-700 uppercase mb-2">Bio-Support</h4>
                                                <p id="consult-bio" class="text-sm text-slate-700">--</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Shared Coaching Hub -->
                                <div id="tab-coaching" class="detail-tab hidden space-y-6">
                                    <div class="section-card">
                                        <h3 class="font-bold text-slate-800 mb-4" data-key="shared_videos">ATC-Escalated Progress Videos</h3>
                                        <p class="text-xs text-slate-500 mb-4 italic">View-only access for clinical context. Reply via Secure Group Chat if intervention is needed.</p>
                                        <div id="detail-video-list" class="space-y-6"></div>
                                    </div>
                                </div>

                                <!-- Treatment Workspace -->
                                <div id="tab-treatment" class="detail-tab hidden space-y-6">
                                    <div id="treatment-active-workspace" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div class="section-card">
                                            <h3 class="font-bold text-slate-800 mb-4" data-key="active_monitoring">Growth Monitoring</h3>
                                            <div id="treatment-stats" class="space-y-4"></div>
                                            <div id="detail-adjustment-log" class="mt-6 space-y-2"></div>
                                        </div>
                                        <div class="section-card">
                                            <h3 class="font-bold text-slate-800 mb-4" data-key="patient_feedback">Patient Sentiment</h3>
                                            <div id="detail-feedback-list" class="space-y-3"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Secure Group Chat -->
                                <div id="tab-chat" class="detail-tab hidden">
                                    <div class="section-card flex flex-col h-[500px]">
                                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                                            <h3 class="font-bold text-slate-800 uppercase text-xs" data-key="collaboration_hub">Secure Group Chat</h3>
                                            <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 font-bold">Patient, ATC, AMD</span>
                                        </div>
                                        <div id="chat-messages" class="flex-1 overflow-y-auto space-y-4 p-2 flex flex-col no-scrollbar"></div>
                                        <div class="mt-4 flex gap-2 pt-4 border-t">
                                            <input type="text" placeholder="Reply..." class="flex-1 px-4 py-2 border rounded-xl outline-none text-sm focus:ring-2 focus:ring-purple-500">
                                            <button class="bg-teal-600 text-white px-4 rounded-xl"><i class="fa-solid fa-paper-plane"></i></button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Clinical Collaboration (AMD-Spec Only) -->
                                <div id="tab-spec-chat" class="detail-tab hidden space-y-6">
                                    <div class="section-card flex flex-col h-[500px] border-l-4 border-slate-500">
                                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                                            <h3 class="font-bold text-slate-800 uppercase text-xs">Private Clinical Collaboration</h3>
                                            <span class="text-[10px] bg-red-100 text-red-700 px-2 py-0.5 rounded font-bold uppercase"><i class="fa-solid fa-lock mr-1"></i> AMD + Specialist Only</span>
                                        </div>
                                        <div class="flex-1 overflow-y-auto space-y-4 p-2 flex flex-col no-scrollbar">
                                            <div class="chat-bubble chat-specialist"><p class="text-[9px] font-black uppercase mb-1">Doc Felix</p><p class="text-sm">Please verify if the molar rotation is inhibiting expansion.</p></div>
                                            <div class="chat-bubble chat-amd"><p class="text-[9px] font-black uppercase mb-1">Dr. Ryan</p><p class="text-sm">Verified. No interference detected.</p></div>
                                        </div>
                                        <div class="mt-4 flex gap-2 pt-4 border-t">
                                            <input type="text" placeholder="Private message to Specialist..." class="flex-1 px-4 py-2 border rounded-xl outline-none text-sm">
                                            <button class="bg-slate-700 text-white px-4 rounded-xl"><i class="fa-solid fa-paper-plane"></i></button>
                                        </div>
                                    </div>
                                </div>

                                <div id="tab-notes" class="detail-tab hidden space-y-6"><div class="section-card"><h3 class="font-bold text-slate-800 mb-4" data-key="clinical_archive">Clinical Archive</h3><div id="detail-internal-notes" class="space-y-3 mb-6"></div><textarea class="w-full h-32 p-4 bg-slate-50 border rounded-xl outline-none text-sm italic text-slate-600" placeholder="New internal observation..."></textarea><div class="mt-4 flex justify-end"><button class="px-6 py-2 bg-teal-600 text-white font-black text-[10px] rounded-lg uppercase shadow-lg">Save Record</button></div></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- PDPA Modal -->
    <div id="pdpa-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white w-full max-w-lg p-8 rounded-2xl shadow-2xl">
            <h3 class="text-xl font-black text-red-600 mb-4 border-b pb-2 uppercase">Specialist Referral Check</h3>
            <div class="bg-amber-50 border-l-4 border-amber-500 p-5 mb-8 rounded-xl space-y-4">
                <div class="flex items-center gap-3"><input type="checkbox" id="c1" class="h-4 w-4 text-teal-600"><label for="c1" class="text-xs text-slate-700 font-bold uppercase cursor-pointer">Written Consent Obtained</label></div>
                <div class="flex items-center gap-3"><input type="checkbox" id="c2" class="h-4 w-4 text-teal-600"><label for="c2" class="text-xs text-slate-700 font-bold uppercase cursor-pointer">Pseudonymized (Strip PII)</label></div>
                <div class="flex items-center gap-3"><input type="checkbox" id="c3" class="h-4 w-4 text-teal-600"><label for="c3" class="text-xs text-slate-700 font-bold uppercase cursor-pointer">Executing Practice DPA</label></div>
            </div>
            <div class="flex gap-4">
                <button onclick="closeModal('pdpa-modal')" class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl font-black text-xs uppercase">Cancel</button>
                <button onclick="confirmConsultation()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-black text-xs uppercase shadow-xl hover:bg-red-700">Confirm & Refer</button>
            </div>
        </div>
    </div>

    <script>
        let currentLang = 'en';

        const statusMap = {
            "Onboarding Complete": "Forms finished; ready for scheduling.",
            "Clinical Appointment Scheduled": "Visit confirmed; awaiting scans.",
            "Imaging In Progress": "Undergoing CBCT, Ceph, or STL scans.",
            "Lab Images Review WIP": "Vetting scans before referral.",
            "Ready for Specialist Referral": "Verified; ready to push.",
            "Pending Specialist Consultation": "Case in California; awaiting report.",
            "Specialist Report Finalized": "Report complete; awaiting sharing.",
            "Pending Payment": "MSO fee required.",
            "STA In Progress": "Lab is fabricating device.",
            "Pending STA Delivery": "Device in transit.",
            "Treatment In Progress": "Active growth phase.",
            "Offboarding": "Final release assessment."
        };

        const translations = {
            en: {
                header_title: "AMD Practitioner Dashboard", nav_group_title: "Practice Management", nav_overview: "Overview", nav_patients: "Patients", nav_intake: "Intake Queue", nav_accounting: "Accounting",
                overview_title: "Case Pipeline Tracking", registry_title: "Patient Registry", col_patient: "Patient", col_intake: "Intake", col_diag: "Diag", col_spec: "Spec", col_cons: "Cons", col_mfg: "Mfg", col_log: "Log", col_ageing: "Ageing Breakdown",
                btn_refer: "Refer to Specialist", tab_clinical: "Clinical Progress", tab_onboarding: "Goals & Pains", tab_diagnostics: "Scans, Analysis & Reports", tab_consultation: "Specialist Consultation", tab_coaching_hub: "Shared Coaching Hub", tab_treatment: "Treatment Workspace", tab_chat: "Case Chat", tab_records: "Practice Records", tab_spec_chat: "Clinical Collaboration", tab_questionnaire: "Patient Questionnaire",
                granular_status: "Granular Workflow Status", motivations: "Core Motivations", pains: "Pain Points", imaging_models: "Imaging & Models", report_locked: "Report Not Available", clinical_design_report: "Clinical Design Report", notes_for_amd: "Notes for AMD", specialist_guidance: "Specialist Guidance", treatment_summary: "Treatment Summary", shared_videos: "ATC-Escalated Progress Videos", active_monitoring: "Growth Monitoring", patient_feedback: "Patient Sentiment", collaboration_hub: "Secure Group Chat", clinical_archive: "Clinical Archive", stat_total_revenue: "Total Revenue (YTD)", stat_pending_fees: "Pending MSO Fees",
                uploaded_diagnostics: "Scans, Analysis & Reports", amd_prescription: "AMD Prescription Summary"
            },
            zh: {
                header_title: "AMD 醫師儀表板", nav_group_title: "實務管理", nav_overview: "總覽", nav_patients: "患者", nav_intake: "入組隊列", nav_accounting: "會計",
                overview_title: "病例管道追踪", registry_title: "患者登記", col_patient: "患者", col_intake: "入組", col_diag: "診斷", col_spec: "專科", col_cons: "諮詢", col_mfg: "製造", col_log: "物流", col_ageing: "時程分析",
                btn_refer: "轉介專科醫生", tab_clinical: "臨床進度", tab_onboarding: "目標與疼痛", tab_diagnostics: "掃描、分析與報告", tab_consultation: "專科醫師諮詢", tab_coaching_hub: "ATC 指導中心", tab_treatment: "治療工作區", tab_chat: "病例對話", tab_records: "診所記錄", tab_spec_chat: "臨床協作", tab_questionnaire: "患者問卷",
                granular_status: "詳細進度狀態", motivations: "核心動力", pains: "痛點", imaging_models: "影像與模型", report_locked: "報告尚未可用", clinical_design_report: "臨床設計報告", notes_for_amd: "致 AMD 醫師備註", specialist_guidance: "專科醫師指導", treatment_summary: "治療摘要", shared_videos: "ATC 轉交進度影片", active_monitoring: "成長監測", patient_feedback: "患者情緒追蹤", collaboration_hub: "安全群組聊天", clinical_archive: "臨床檔案", stat_total_revenue: "年累計總收入", stat_pending_fees: "待處理 MSO 費用",
                uploaded_diagnostics: "掃描、分析與報告", amd_prescription: "AMD 處方摘要"
            }
        };

        const mockPatients = [
            { 
                name: "John Lee", id: "TW-001", atc: "Jane Chen", totalDays: 42, referred: true, 
                currentStatus: "STA In Progress", phaseIndex: 4, 
                motivation: "Eliminate chronic daytime fatigue and achieve airway health.", pains: "Severe snoring, morning headaches.",
                qHist: "High Blood Pressure (Family)",
                phases: { intake: 5, diag: 12, spec: 8, cons: 4, mfg: 13, log: 0, treat: 0, offb: 0 },
                granular: {
                    "Intake": { status: "Complete", age: 5, steps: [{name: "Forms", done: true}, {name: "Scheduling", done: true}, {name: "Confirmed", done: true}] },
                    "Diagnostics": { status: "Complete", age: 12, steps: [{name: "CBCT Airway", done: true}, {name: "Lateral Ceph", done: true}] },
                    "Specialist Review": { status: "Complete", age: 8, steps: [{name: "Vitals Check", done: true}, {name: "Doc Felix Refer", done: true}] },
                    "Manufacturing": { status: "Active", age: 13, steps: [{name: "Order Rec'd", done: true}, {name: "3D Print", done: false, pending: "STA Lab"}] }
                },
                prescription: "Rapid expansion focus. 2.0 turns bi-weekly. Target intermolar width expansion: +4.5mm. Correct velopharyngeal restriction.",
                guidance: "Monitor FMA closely. Accelerate turns if airway volume remains critical.",
                bio: "Bone broth daily. Magnesium supplementation.",
                details: { target: "+4.5mm", protocol: "2 Turns / Bi-weekly" },
                analysis: "Sassouni analysis shows class II malocclusion with severe airway constriction. Schwartz analysis indicates 5mm transverse deficiency.",
                notes: "Patient highly motivated but sensitive to dental pressure.",
                summary: "18-month active prescription. Phase 1: Expansion focus.",
                internalNotes: [{date: "Jan 10, 2026", author: "Dr. Ryan Chiang", text: "Trial turns successful."}, {date: "Dec 15, 2025", author: "Dr. Ryan Chiang", text: "Onboarding done."}],
                treatment: { width: "42.5mm", target: "44.0mm", progress: 65, turns: 14, logs: [{date:"Jan 05", tech:"2 Turns"}], sentiment: [{date:"Jan 08", msg:"Tight but tolerable.", mood:"Positive"}] },
                videos: [
                    { id: 'v1', date: 'Jan 12', transcript: "I'm feeling slight tension on the upper left molar. Is it normal?", shared: true, comment: "" }
                ],
                chat: [{ role: "atc", name: "Jane Chen", msg: "Hi John!" }, { role: "amd", name: "Dr. Ryan", msg: "Video reviewed. Tension is expected." }]
            },
            { name: "Mei-Ling Wu", id: "TW-002", atc: "Jane Chen", totalDays: 14, currentStatus: "Lab Images Review WIP", phaseIndex: 1, phases: { intake: 3, diag: 11, spec: 0, cons: 0, mfg: 0, log: 0, treat: 0, offb: 0 }, motivation: "TMJ relief.", pains: "Clicking.", qHist: "--", granular: { "Diagnostics": { status: "Active", age: 11, steps: [{name: "CBCT", done: true}, {name: "Radiology Review", done: false}] } }, prescription: "Awaiting referral.", internalNotes: [], treatment: null, videos: [], chat: [] },
            { name: "Alice Chang", id: "TW-004", atc: "Kaushal V.", totalDays: 240, referred: true, currentStatus: "Treatment In Progress", phaseIndex: 6, phases: { intake: 10, diag: 15, spec: 12, cons: 10, mfg: 25, log: 20, treat: 148, offb: 0 }, motivation: "Correction.", pains: "Mouth breathing.", qHist: "Asthma", granular: { "Treatment": { status: "Active", age: 148, steps: [{name: "Daily Wear", done: true}] } }, prescription: "Maintain 18h wear-time.", internalNotes: [], treatment: { width: "43.8mm", target: "45.0mm", progress: 85, turns: 32, logs: [], sentiment: [] }, videos: [], chat: [] }
        ];

        function switchMainPane(id) {
            const targetPane = document.getElementById(`pane-${id}`);
            if (!targetPane) return;
            document.querySelectorAll('.main-pane').forEach(p => p.classList.add('hidden'));
            targetPane.classList.remove('hidden');
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`nav-${id}`);
            if (btn) btn.classList.add('active');
        }

        function switchDetailTab(id) {
            const targetTab = document.getElementById(`tab-${id}`);
            if (!targetTab) return;
            document.querySelectorAll('.detail-tab').forEach(t => t.classList.add('hidden'));
            targetTab.classList.remove('hidden');
            document.querySelectorAll('.sub-nav-btn').forEach(b => b.classList.remove('active'));
            const clickedBtn = Array.from(document.querySelectorAll('.sub-nav-btn')).find(btn => btn.getAttribute('onclick')?.includes(`'${id}'`));
            if (clickedBtn) clickedBtn.classList.add('active');
        }

        function selectPatient(id) {
            const p = mockPatients.find(x => x.id === id);
            if (!p) return;
            
            const els = {
                name: 'detail-name', id: 'detail-id', atc: 'detail-atc', mot: 'detail-motivation', pain: 'detail-pains', age: 'detail-total-ageing', timeline: 'detail-granular-timeline', reportLocked: 'report-locked', cNotes: 'consult-notes', cGuidance: 'consult-guidance', cSummary: 'consult-summary', vList: 'detail-video-list', iNotes: 'detail-internal-notes', chat: 'chat-messages', tStats: 'treatment-stats', tLog: 'detail-adjustment-log', sLog: 'detail-feedback-list', sList: 'detail-scans-list', motQ: 'q-mot', painQ: 'q-pain', histQ: 'q-hist', analysis: 'analysis-summary', cTarget: 'consult-target', cProtocol: 'consult-protocol', cBio: 'consult-bio'
            };

            const set = (elId, val) => { const el = document.getElementById(els[elId]); if(el) el.innerText = val; };
            const html = (elId, val) => { const el = document.getElementById(els[elId]); if(el) el.innerHTML = val; };

            set('name', p.name); set('id', p.id); set('atc', p.atc); set('mot', p.motivation); set('pain', p.pains); set('age', `${p.totalDays}d`);
            set('motQ', p.motivation); set('painQ', p.pains); set('histQ', p.qHist);

            const phaseKeys = ['intake', 'diag', 'spec', 'cons', 'mfg', 'log', 'treat', 'offb'];
            html('timeline', Object.entries(p.granular || {}).map(([ph, data]) => `<div class="relative pl-8 border-l-2 ${data.status === 'Complete' ? 'border-teal-500' : 'border-slate-200'}"><div class="absolute -left-2 top-0 w-4 h-4 rounded-full ${data.status === 'Complete' ? 'bg-teal-500' : 'bg-slate-200'}"></div><div class="mb-4 flex justify-between"><b>${ph}</b><span class="text-[9px] font-black">${data.age}d age</span></div></div>`).join(''));

            const reportLocked = document.getElementById(els.reportLocked);
            if(reportLocked) reportLocked.classList.toggle('hidden', p.referred);
            if(p.referred) { 
                set('cNotes', p.notes); set('cGuidance', p.guidance); set('cSummary', p.summary); 
                set('analysis', p.analysis); 
                if (p.details) {
                    set('cTarget', p.details.target); set('cProtocol', p.details.protocol); set('cBio', p.bio);
                }
            }

            html('vList', p.videos.map(v => `<div class="p-4 border rounded-xl flex gap-6 bg-slate-50/50"><div class="w-40 aspect-video bg-slate-900 rounded-lg flex items-center justify-center"><i class="fa-solid fa-play text-white opacity-30"></i></div><div class="flex-1"><p class="text-[10px] font-bold text-slate-400 uppercase">${v.date} submission</p><p class="text-sm italic text-slate-600 mb-3">"${v.transcript}"</p><textarea class="w-full p-2 bg-white border rounded text-xs" placeholder="Add clinical note to this video..."></textarea></div></div>`).join('') || '<p class="text-xs text-slate-400 py-6 text-center">No videos shared by ATC.</p>');
            
            html('iNotes', p.internalNotes.map(n => `<div class="p-3 bg-slate-50 border rounded-lg mb-2 text-xs"><b>${n.date} - ${n.author}</b><p class="italic text-slate-600 mt-1">"${n.text}"</p></div>`).join(''));
            html('chat', p.chat.map(m => `<div class="chat-bubble chat-${m.role}"><p class="text-[9px] font-black uppercase mb-1">${m.name}</p><p class="text-sm">${m.msg}</p></div>`).join('') || '<p class="text-center text-slate-300 py-12">Start a conversation.</p>');
            
            // Updated Scans Section with timestamps and view dropdowns
            html('sList', `
                <div class="scan-card p-3 border">
                    <div class="flex justify-between items-center mb-2"><i class="fa-solid fa-x-ray text-slate-300 text-xl"></i><span class="text-[9px] font-bold text-slate-500 uppercase">Lateral Ceph</span></div>
                    <p class="text-[10px] text-slate-800 font-bold">Capture: 2025/12/10</p>
                    <select class="w-full mt-2 text-[10px] border bg-slate-50"><option>Current View</option><option>2025/09/01 (Initial)</option></select>
                </div>
                <div class="scan-card p-3 border">
                    <div class="flex justify-between items-center mb-2"><i class="fa-solid fa-cube text-slate-300 text-xl"></i><span class="text-[9px] font-bold text-slate-500 uppercase">CBCT Airway</span></div>
                    <p class="text-[10px] text-slate-800 font-bold">Capture: 2025/12/10</p>
                    <select class="w-full mt-2 text-[10px] border bg-slate-50"><option>Current View</option><option>2025/09/01 (Initial)</option></select>
                </div>
                <div class="scan-card p-3 border">
                    <div class="flex justify-between items-center mb-2"><i class="fa-solid fa-teeth text-slate-300 text-xl"></i><span class="text-[9px] font-bold text-slate-500 uppercase">3D Intra-Oral</span></div>
                    <p class="text-[10px] text-slate-800 font-bold">Capture: 2025/12/10</p>
                    <select class="w-full mt-2 text-[10px] border bg-slate-50"><option>Current View</option><option>2025/09/01 (Initial)</option></select>
                </div>
                <div class="scan-card p-3 border">
                    <div class="flex justify-between items-center mb-2"><i class="fa-solid fa-camera text-slate-300 text-xl"></i><span class="text-[9px] font-bold text-slate-500 uppercase">Clinical Photos</span></div>
                    <p class="text-[10px] text-slate-800 font-bold">Capture: 2025/12/10</p>
                    <select class="w-full mt-2 text-[10px] border bg-slate-50"><option>Current View</option><option>2025/09/01 (Initial)</option></select>
                </div>
            `);

            if(p.treatment) {
                html('tStats', `<div class="p-4 bg-teal-50 rounded-xl border border-teal-100"><div class="flex justify-between text-xs mb-2"><b>Progress</b><span>${p.treatment.progress}%</span></div><div class="w-full bg-teal-200 h-1.5 rounded-full"><div class="bg-teal-600 h-1.5 rounded-full" style="width:${p.treatment.progress}%"></div></div></div>`);
                html('tLog', p.treatment.logs.map(l => `<div class="p-2 border rounded-lg flex justify-between text-[10px]"><span>${l.date}</span><b>${l.tech}</b></div>`).join(''));
                html('sLog', p.treatment.sentiment.map(s => `<div class="p-2 border rounded-lg bg-slate-50 text-[10px]"><b>${s.date}</b>: ${s.msg}</div>`).join(''));
            } else { html('tStats', '<p class="text-xs text-slate-400">Treatment metrics not yet active.</p>'); }

            switchMainPane('client-detail');
        }

        function renderTracker() {
            const body = document.getElementById('tracker-body');
            const phaseKeys = ['intake', 'diag', 'spec', 'cons', 'mfg', 'log'];
            body.innerHTML = mockPatients.map(p => {
                const currentPhaseDays = p.phases[phaseKeys[p.phaseIndex]] || (p.phaseIndex >= 6 ? (p.phaseIndex === 6 ? p.phases.treat : p.phases.offb) : 0);
                return `<tr class="hover:bg-slate-50 cursor-pointer transition-colors group" onclick="selectPatient('${p.id}')"><td class="px-6 py-4 font-bold text-xs">${p.name}<br><span class="text-[9px] font-normal text-teal-600 uppercase">${p.currentStatus}</span></td>${phaseKeys.map((key, idx) => `<td class="text-center px-2 py-4"><span class="ageing-pill ${idx < p.phaseIndex ? 'ageing-done' : idx === p.phaseIndex ? 'ageing-active' : ''}">${p.phases[key]}d</span></td>`).join('')}<td class="px-6 py-4 text-right text-xs font-black text-teal-600">${currentPhaseDays}d / ${p.totalDays}d</td></tr>`;
            }).join('');
        }

        function toggleLanguage() { currentLang = currentLang === 'en' ? 'zh' : 'en'; updateText(); }
        function updateText() {
            const data = translations[currentLang];
            document.querySelectorAll('[data-key]').forEach(el => { const k = el.getAttribute('data-key'); if (data[k]) el.textContent = data[k]; });
            const btn = document.getElementById('lang-toggle'); if(btn) btn.textContent = currentLang === 'en' ? '中文' : 'English';
            renderTracker();
        }

        function openPDPA() { document.getElementById('pdpa-modal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function confirmConsultation() { alert("Case referred. Files pseudonymized."); closeModal('pdpa-modal'); }
        function filterPatients() { /* Logic simplified for this view */ }

        window.onload = () => { updateText(); };
    </script>
</body>
</html>
