<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMD ATC Dashboard | Case Coordination Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .bg-purple-gradient { background-image: linear-gradient(to right, #7c3aed, #4f46e5); }
        .section-card { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        
        .nav-button { padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: #64748b; border-radius: 0.5rem; transition: all 0.2s ease; width: 100%; display: flex; align-items: center; gap: 10px; }
        .nav-button:hover { background-color: #f5f3ff; color: #7c3aed; }
        .nav-button.active { background-color: #f5f3ff; color: #7c3aed; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border-right: 3px solid #7c3aed; }

        .tracker-header { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; padding: 1rem 0.5rem; border-bottom: 2px solid #f1f5f9; cursor: help; }
        .ageing-pill { font-size: 0.65rem; padding: 0.1rem 0.4rem; border-radius: 4px; font-weight: 700; display: inline-block; }
        .ageing-done { background-color: #f1f5f9; color: #94a3b8; }
        .ageing-active { background-color: #f5f3ff; color: #7c3aed; border: 1px solid #ddd6fe; }
        
        .sub-nav-btn { padding: 0.6rem 1rem; font-size: 0.8rem; font-weight: 600; color: #64748b; border-radius: 0.5rem; transition: all 0.2s; display: flex; align-items: center; gap: 8px; width: 100%; text-align: left; border-left: 3px solid transparent; }
        .sub-nav-btn:hover { background-color: #f8fafc; color: #7c3aed; }
        .sub-nav-btn.active { background-color: #f5f3ff; color: #7c3aed; border-left: 3px solid #7c3aed; font-weight: 700; }

        .chat-bubble { padding: 0.75rem 1rem; border-radius: 1rem; max-width: 85%; font-size: 0.85rem; line-height: 1.5; margin-bottom: 0.75rem; }
        .chat-amd { background-color: #ecfdf5; align-self: flex-start; border-bottom-left-radius: 0; border: 1px solid #d1fae5; }
        .chat-atc { background-color: #f5f3ff; align-self: flex-end; border-bottom-right-radius: 0; border: 1px solid #ddd6fe; }
        .chat-patient { background-color: #dbeafe; align-self: flex-start; border-bottom-left-radius: 0; border: 1px solid #bfdbfe; }

        .scan-card { aspect-ratio: 1; background: #f8fafc; border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px dashed #cbd5e1; transition: border-color 0.2s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen">
        <header class="bg-purple-gradient shadow-sm sticky top-0 z-50">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                 <div class="flex items-center gap-3">
                     <svg width="32" height="32" viewBox="0 0 100 100" class="fill-white">
                        <path d="M70,20 C60,10 40,10 30,20 C20,30 15,50 20,65 C22,70 25,75 30,78 C35,82 45,85 55,85 C65,85 75,80 80,70 C85,60 85,30 70,20 Z M50,15 C65,15 75,25 78,40 C80,50 80,65 72,78 C65,85 50,85 40,78 C35,74 30,65 30,50 C30,35 40,15 50,15 Z" opacity="0.4"/>
                        <path d="M45,45 Q50,40 55,45 Q60,50 55,65 Q50,75 45,65 Q40,55 45,45 Z" fill="#e9d5ff"/>
                        <path d="M35,65 Q40,75 55,75 Q70,75 75,65" stroke="white" stroke-width="4" fill="none" stroke-linecap="round"/>
                     </svg>
                     <h1 class="text-xl font-bold text-white tracking-tight">AMD ATC Dashboard</h1>
                 </div>
                <div class="flex items-center space-x-4">
                    <button id="lang-toggle" onclick="toggleLanguage()" class="py-1.5 px-4 rounded-full bg-white/10 text-white font-semibold text-xs border border-white/20 hover:bg-white/20 transition">中文</button>
                    <div class="h-8 w-8 rounded-full bg-purple-800 flex items-center justify-center text-white text-xs font-bold border border-purple-400">JC</div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <div class="lg:grid lg:grid-cols-4 lg:gap-8">
                
                <!-- ATC Navigation -->
                <div class="lg:col-span-1 mb-8">
                    <div class="space-y-6 sticky top-24">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-2">Assigned Practice</h3>
                            <select id="clinic-selector" onchange="changeClinic(this.value)" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-purple-700 outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                                <option value="harmony" selected>Harmony Clinic Taipei</option>
                                <option value="zen">Zen Dental Studio</option>
                                <option value="legacy">Legacy Airway Center</option>
                            </select>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 px-2">ATC Portal</h3>
                            <nav class="flex flex-col space-y-1">
                                <button id="nav-overview" class="nav-button active" onclick="switchMainPane('overview')"><i class="fa-solid fa-house-chimney w-4"></i> Overview</button>
                                <button id="nav-patients" class="nav-button" onclick="switchMainPane('patients')"><i class="fa-solid fa-users w-4"></i> Patient Registry</button>
                                <button id="nav-videos" class="nav-button" onclick="switchMainPane('videos')"><i class="fa-solid fa-video w-4"></i> Global Video Hub <span id="video-count-badge" class="ml-auto bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-black">--</span></button>
                                <button id="nav-followups" class="nav-button" onclick="switchMainPane('followups')"><i class="fa-solid fa-bell w-4"></i> Action Queue</button>
                                <button id="nav-payments" class="nav-button" onclick="switchMainPane('payments')"><i class="fa-solid fa-wallet w-4"></i> Accounting</button>
                            </nav>
                        </div>
                    </div>
                </div>

                <div id="content-area" class="lg:col-span-3 space-y-8">
                    
                    <!-- 1. Overview Pane -->
                    <div id="pane-overview" class="main-pane space-y-6">
                        <div class="flex justify-between items-end">
                            <div><h2 class="text-2xl font-black text-slate-800 tracking-tight" id="overview-clinic-name">--</h2><p class="text-xs text-slate-400 font-bold uppercase" id="overview-doctor-name">--</p></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="section-card border-l-4 border-purple-500"><p class="text-[10px] font-black text-slate-400 uppercase">My Active Cases</p><p class="text-2xl font-black text-slate-800" id="stat-cases">--</p></div>
                            <div class="section-card border-l-4 border-amber-500"><p class="text-[10px] font-black text-slate-400 uppercase">Pending Scans</p><p class="text-2xl font-black text-slate-800" id="stat-scans">--</p></div>
                            <div class="section-card border-l-4 border-red-500"><div class="flex justify-between items-center"><p class="text-[10px] font-black text-slate-400 uppercase">New Video MSGs</p><span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span></div><p class="text-2xl font-black text-slate-800" id="stat-videos">--</p></div>
                        </div>

                        <div class="section-card">
                            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-bolt text-amber-500"></i> Follow-up Priority</h3>
                            <div class="space-y-3" id="priority-list"></div>
                        </div>

                        <div class="section-card overflow-hidden !p-0 border border-slate-100">
                            <div class="p-4 border-b border-slate-100 flex justify-between items-center"><h3 class="font-bold text-slate-800">Master Case Tracker</h3></div>
                            <div class="overflow-x-auto no-scrollbar">
                                <table class="min-w-full divide-y divide-slate-100">
                                    <thead class="bg-slate-50/50">
                                        <tr>
                                            <th class="tracker-header text-left pl-6">Patient</th>
                                            <th class="tracker-header text-center" title="Intake">Intake</th>
                                            <th class="tracker-header text-center" title="Diagnostics">Diag</th>
                                            <th class="tracker-header text-center" title="Spec Review">Spec</th>
                                            <th class="tracker-header text-center text-purple-600 bg-purple-50/50" title="Payment">Pay</th>
                                            <th class="tracker-header text-center" title="Cons & Design">Cons</th>
                                            <th class="tracker-header text-center" title="Manufacturing">Mfg</th>
                                            <th class="tracker-header text-center" title="Logistics">Log</th>
                                            <th class="tracker-header text-center" title="Delivery">Del</th>
                                            <th class="tracker-header text-center" title="Maintenance">Maint</th>
                                            <th class="tracker-header text-right pr-6">Ageing</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tracker-body" class="bg-white divide-y divide-slate-100 text-sm"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Global Video Hub -->
                    <div id="pane-videos" class="main-pane hidden space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-black text-slate-800 tracking-tight">Global Video Coaching Hub</h2>
                            <span class="px-3 py-1 bg-purple-100 text-purple-700 text-xs font-bold rounded-full border border-purple-200">Across All Clinics</span>
                        </div>
                        <div id="global-video-list" class="grid grid-cols-1 gap-6"></div>
                    </div>

                    <!-- 3. Action Queue -->
                    <div id="pane-followups" class="main-pane hidden space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-black text-slate-800 tracking-tight">Coordination Action Queue</h2>
                            <button class="bg-purple-600 text-white px-4 py-2 rounded-lg text-xs font-black uppercase tracking-widest shadow-md">Batch Update</button>
                        </div>
                        <div id="task-list-full" class="space-y-4"></div>
                    </div>

                    <!-- 4. Patient Registry -->
                    <div id="pane-patients" class="main-pane hidden space-y-6">
                        <h2 class="text-2xl font-black text-slate-800 tracking-tight">Patient Registry</h2>
                        <div class="section-card">
                            <div class="relative mb-6">
                                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                                <input type="text" id="registry-search" placeholder="Search across all practices..." class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="overflow-hidden border border-slate-100 rounded-lg">
                                <table class="w-full text-left">
                                    <tbody id="patient-registry-body" class="divide-y divide-slate-50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Detailed Case Workspace -->
                    <div id="pane-client-detail" class="main-pane hidden space-y-6">
                        <div class="flex items-center justify-between gap-4 border-b pb-6">
                            <div class="flex items-center gap-4">
                                <button onclick="switchMainPane('overview')" class="h-10 w-10 rounded-full border border-slate-200 flex items-center justify-center text-slate-400 hover:text-purple-600 transition"><i class="fa-solid fa-arrow-left"></i></button>
                                <div><h2 id="detail-name" class="text-2xl font-black text-slate-900 leading-none mb-1">--</h2><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">ID: <span id="detail-id" class="text-purple-600 font-mono">--</span> <span class="w-1 h-1 rounded-full bg-slate-300"></span> Clinic: <span id="detail-clinic-label" class="text-teal-600 font-bold uppercase">--</span></p></div>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row gap-6">
                            <div class="md:w-64 flex-shrink-0">
                                <div class="bg-white p-3 rounded-xl border border-slate-100 space-y-1 sticky top-24">
                                    <button class="sub-nav-btn active" onclick="switchDetailTab('clinical')"><i class="fa-solid fa-list-check w-4"></i> Progress Tracker</button>
                                    <button class="sub-nav-btn" onclick="switchDetailTab('diagnostics')"><i class="fa-solid fa-microscope w-4"></i> Scans & Reports</button>
                                    <button class="sub-nav-btn" onclick="switchDetailTab('questionnaire')"><i class="fa-solid fa-clipboard-question w-4"></i> Questionnaire</button>
                                    <button class="sub-nav-btn" onclick="switchDetailTab('treatment')"><i class="fa-solid fa-screwdriver-wrench w-4"></i> Treatment Plan</button>
                                    <button class="sub-nav-btn" onclick="switchDetailTab('hub')"><i class="fa-solid fa-video w-4"></i> Interaction Hub</button>
                                    <button class="sub-nav-btn" onclick="switchDetailTab('chat')"><i class="fa-solid fa-comments w-4"></i> Case Chat</button>
                                </div>
                            </div>

                            <div class="flex-1 min-w-0 space-y-6">
                                <div id="tab-clinical" class="detail-tab space-y-6"><div class="section-card"><h3 class="font-bold text-slate-800 mb-6 uppercase text-xs">Clinical Timeline</h3><div id="detail-granular-timeline" class="space-y-8 mt-6"></div></div></div>
                                
                                <div id="tab-diagnostics" class="detail-tab hidden space-y-6">
                                    <div class="section-card">
                                        <h3 class="font-bold text-slate-800 mb-4 uppercase text-xs tracking-widest">Scans, Analysis & Reports</h3>
                                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="detail-scans-list"></div>
                                        <h4 class="text-[10px] font-black text-slate-400 uppercase mb-2">Expert Analysis Summary</h4>
                                        <div class="p-3 bg-amber-50 border border-amber-100 rounded-lg mb-6"><p class="text-xs text-amber-800 italic" id="analysis-summary">--</p></div>
                                        <h4 class="text-[10px] font-black text-slate-400 uppercase mb-2">Clinical Reports</h4>
                                        <div class="space-y-2" id="detail-reports-list"></div>
                                    </div>
                                </div>

                                <div id="tab-questionnaire" class="detail-tab hidden space-y-6">
                                    <div class="section-card bg-purple-50/30 border border-purple-100">
                                        <h3 class="font-bold text-purple-800 mb-4 uppercase text-xs tracking-widest">Baseline Symptom Assessment</h3>
                                        <div class="space-y-4 text-sm text-slate-700">
                                            <div class="bg-white p-3 rounded-lg"><h4 class="font-bold mb-1">Motivations</h4><p id="q-mot">--</p></div>
                                            <div class="bg-white p-3 rounded-lg"><h4 class="font-bold mb-1">Pain Points</h4><p id="q-pain">--</p></div>
                                            <div class="bg-white p-3 rounded-lg"><h4 class="font-bold mb-1">Medical History</h4><p id="q-hist">--</p></div>
                                            <div class="bg-white p-3 rounded-lg"><h4 class="font-bold mb-1">MSQ Baseline</h4><p id="q-msq">Head/Neck: 14 | Cardiopulmonary: 5 | Digestive: 2 | Brain/Sleep: 18</p></div>
                                        </div>
                                    </div>
                                </div>

                                <div id="tab-treatment" class="detail-tab hidden space-y-6">
                                    <div class="section-card border-l-4 border-teal-500 bg-teal-50/30 mb-6">
                                        <h3 class="font-bold text-teal-800 mb-4 uppercase text-xs tracking-widest">Treatment Interventions</h3>
                                        <div class="flex items-center gap-6 mb-4">
                                            <div class="flex-1">
                                                <p class="text-[10px] font-bold text-slate-500 uppercase">Appliance Completion Progress</p>
                                                <div class="flex items-center gap-4 mt-1">
                                                    <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden"><div id="app-progress-bar" class="h-full bg-teal-500" style="width: 25%"></div></div>
                                                    <span id="app-percent-text" class="text-xs font-black text-teal-700">25%</span>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-[10px] font-bold text-slate-500 uppercase">Prescription</p>
                                                <p class="text-xs font-black text-slate-800">24 Months</p>
                                            </div>
                                        </div>
                                        <div class="bg-white p-4 border border-teal-100 rounded-xl mb-4">
                                            <p class="text-xs font-black text-teal-800 uppercase mb-2">Prescribed Nutrition Focus</p>
                                            <ul class="space-y-1.5 list-disc list-inside text-xs text-slate-600 font-medium pl-2">
                                                <li>Increase intake of bone broth for collagen support.</li>
                                                <li>Ensure adequate calcium and magnesium levels.</li>
                                                <li>Focus on essential fatty acids (Omega-3).</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="section-card"><h3 class="font-bold text-slate-800 mb-4 uppercase text-xs tracking-widest">Clinical Observation Log</h3><div id="detail-treatment-log" class="space-y-3"></div></div>
                                </div>

                                <div id="tab-hub" class="detail-tab hidden space-y-6">
                                    <div class="section-card border-t-8 border-pink-500"><h3 class="font-bold text-slate-800 mb-4 uppercase text-xs tracking-widest">Interaction Hub & Coaching</h3><div id="detail-hub-videos" class="space-y-4"></div></div>
                                </div>

                                <div id="tab-chat" class="detail-tab hidden"><div class="section-card flex flex-col h-[500px]"><h3 class="font-bold text-slate-800 mb-4 border-b pb-2 uppercase text-xs tracking-widest">Secure Group Chat</h3><div id="chat-messages" class="flex-1 overflow-y-auto space-y-4 p-2 flex flex-col no-scrollbar"></div><div class="mt-4 flex gap-2 pt-4 border-t"><input type="text" placeholder="Reply to group..." class="flex-1 px-4 py-2 border rounded-xl outline-none text-sm focus:ring-2 focus:ring-purple-500"><button class="bg-purple-600 text-white px-4 rounded-xl hover:bg-purple-700 transition"><i class="fa-solid fa-paper-plane"></i></button></div></div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Accounting Pane -->
                    <div id="pane-payments" class="main-pane hidden space-y-6">
                        <h2 class="text-2xl font-black text-slate-800 tracking-tight">Practice Financials</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="accounting-summary"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentClinic = 'harmony';
        let currentLang = 'en';

        const mockPatients = [
            { clinic: 'harmony', name: "John Lee", id: "TW-001", totalDays: 42, currentStatus: "STA In Progress", phaseIndex: 5, 
                phases: { intake: 5, diag: 12, spec: 8, pay: 4, cons: 4, mfg: 13, log: 0, del: 0, treat: 0, offb: 0 },
                motivation: "Eliminate chronic fatigue and snoring.", pains: "Apnea, frequent headaches.", qHist: "High Blood Pressure (Family)",
                analysis: "Structural analysis confirms severe airway constriction. 5mm transverse deficiency identified.",
                internalNotes: [{date: "Jan 10, 2026", author: "Dr. Ryan Chiang", text: "Trial turns successful."}],
                videos: [{ id: 'v1', date: 'Jan 10', transcript: "Feeling tight on left molar. Is this expansion normal?", escalated: false }],
                granular: {
                    "Intake": { status: "Complete", age: 5, steps: [{name: "Forms", done: true}, {name: "Scheduling", done: true}] },
                    "Diagnostics": { status: "Complete", age: 12, steps: [{name: "CBCT Airway", done: true}, {name: "STL Models", done: true}] },
                    "Spec Review": { status: "Complete", age: 8, steps: [{name: "Referral Push", done: true}] },
                    "Payment": { status: "Complete", age: 4, steps: [{name: "MSO Fee Paid", done: true, action: "Mark Payment Received"}] },
                    "Manufacturing": { status: "Active", age: 13, steps: [{name: "Order Rec'd", done: true}, {name: "3D Print", done: false, pending: "STA Lab"}] }
                }
            },
            { clinic: 'harmony', name: "David Hsu", id: "TW-005", totalDays: 35, currentStatus: "Pending Payment", phaseIndex: 3, 
                phases: { intake: 6, diag: 14, spec: 10, pay: 5, cons: 0, mfg: 0, log: 0, del: 0, treat: 0, offb: 0 }, 
                motivation: "Migraine relief.", pains: "Mouth breathing.", qHist: "--",
                videos: [{ id: 'v5', date: 'Jan 15', transcript: "Asking about financing options for treatment.", escalated: true }], 
                analysis: "Awaiting payment to unlock clinical design.",
                granular: { "Payment": { status: "Action Needed", age: 5, steps: [{name: "Agreement", done: true}, {name: "MSO Fee", done: false, action: "Mark Payment Received"}] } }
            },
            { clinic: 'zen', name: "Sarah Chen", id: "TW-045", totalDays: 15, currentStatus: "Diagnostics In Progress", phaseIndex: 1, 
                phases: { intake: 5, diag: 10, spec: 0, pay: 0, cons: 0, mfg: 0, log: 0, del: 0, treat: 0, offb: 0 }, 
                motivation: "Fixing overbite.", pains: "Shoulder tension.", qHist: "None",
                videos: [{ id: 'v2', date: 'Jan 12', transcript: "Scan resolution question. Specialist asked for rescan.", escalated: true }],
                granular: { "Diagnostics": { status: "Active", age: 10, steps: [{name: "CBCT", done: true}, {name: "Ceph", done: false}] } }
            },
            { clinic: 'legacy', name: "Robert Wilson", id: "TW-110", totalDays: 142, currentStatus: "Active Maintenance", phaseIndex: 9, 
                phases: { intake: 5, diag: 10, spec: 5, pay: 2, cons: 3, mfg: 10, log: 5, del: 2, treat: 100, offb: 0 }, 
                motivation: "Long-term wellness.", pains: "Fatigue.", qHist: "None",
                videos: [{ id: 'v3', date: 'Jan 08', transcript: "Maintenance check-in. Everything feels stable.", escalated: false }], 
                analysis: "Maintenance phase. Expansion complete.",
                granular: { "Maintenance": { status: "Active", age: 100, steps: [{name: "Monthly Check", done: true}] } }
            }
        ];

        const actionTasks = [
            { patient: "David Hsu", clinic: "Harmony", task: "Mark Payment Received", priority: "High", due: "Due now" },
            { patient: "Sarah Chen", clinic: "Zen", task: "Verify Scan Resolution Alert", priority: "High", due: "3h ago" },
            { patient: "James Wilson", clinic: "Legacy", task: "Confirm postage tracking for device", priority: "Low", due: "Tomorrow" },
            { patient: "John Lee", clinic: "Harmony", task: "Logistics Tracking: STL to Lab", priority: "Medium", due: "1h ago" }
        ];

        function switchMainPane(id) {
            const targetPane = document.getElementById(`pane-${id}`);
            if (!targetPane) return;
            document.querySelectorAll('.main-pane').forEach(p => p.classList.add('hidden'));
            targetPane.classList.remove('hidden');
            document.querySelectorAll('.nav-button').forEach(b => { if(b) b.classList.remove('active'); });
            const navBtn = document.getElementById(`nav-${id}`);
            if (navBtn) navBtn.classList.add('active');
        }

        function switchDetailTab(id) {
            document.querySelectorAll('.detail-tab').forEach(t => t.classList.add('hidden'));
            const target = document.getElementById(`tab-${id}`);
            if (target) target.classList.remove('hidden');
            document.querySelectorAll('.sub-nav-btn').forEach(b => b.classList.remove('active'));
            if (event) event.currentTarget.classList.add('active');
        }

        function renderTracker() {
            const body = document.getElementById('tracker-body');
            const phaseKeys = ['intake', 'diag', 'spec', 'pay', 'cons', 'mfg', 'log', 'del', 'treat']; 
            body.innerHTML = mockPatients.filter(p => p.clinic === currentClinic).map(p => {
                const currentPhaseDays = p.phases[phaseKeys[p.phaseIndex]] || 0;
                return `<tr class="hover:bg-slate-50 cursor-pointer transition-colors group" onclick="selectPatient('${p.id}')">
                    <td class="px-6 py-4 font-bold text-xs">${p.name}<br><span class="text-[9px] font-normal text-purple-600 uppercase">${p.currentStatus}</span></td>
                    ${phaseKeys.map((key, idx) => `<td class="text-center px-1 py-4"><span class="ageing-pill ${idx < p.phaseIndex ? 'ageing-done' : idx === p.phaseIndex ? 'ageing-active' : ''}">${p.phases[key] || 0}d</span></td>`).join('')}
                    <td class="px-6 py-4 text-right text-xs font-black text-purple-600">${p.totalDays}d</td>
                </tr>`;
            }).join('');
        }

        function selectPatient(id) {
            const p = mockPatients.find(x => x.id === id);
            if (!p) return;

            document.getElementById('detail-name').innerText = p.name;
            document.getElementById('detail-id').innerText = p.id;
            document.getElementById('detail-clinic-label').innerText = p.clinic;

            // Granular timeline snippet
            const phaseKeys = ['intake', 'diag', 'spec', 'pay', 'cons', 'mfg', 'log', 'del', 'treat', 'offb']; 
            const timelineBody = document.getElementById('detail-granular-timeline');
            if (timelineBody) {
                timelineBody.innerHTML = Object.entries(p.granular || {}).map(([phase, data]) => `
                    <div class="relative pl-8 border-l-2 ${data.status === 'Complete' ? 'border-purple-500' : 'border-slate-200'}">
                        <div class="absolute -left-2 top-0 w-4 h-4 rounded-full ${data.status === 'Complete' ? 'bg-purple-500 ring-4 ring-purple-50' : 'bg-slate-100 ring-4 ring-slate-50'}"></div>
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2"><h4 class="font-black text-slate-800 uppercase text-[10px]">${phase}</h4><span class="text-[9px] font-black uppercase text-purple-600">${data.age}d age</span></div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                ${data.steps.map(step => `
                                    <div class="p-2 border rounded-lg ${step.done ? 'bg-purple-50 border-purple-100' : 'bg-slate-50 border-slate-100'}">
                                        <div class="flex items-center gap-2">
                                            <i class="fa-solid ${step.done ? 'fa-circle-check text-purple-500' : 'fa-circle-notch fa-spin text-slate-300'} text-[10px]"></i>
                                            <span class="text-[9px] font-bold ${step.done ? 'text-purple-700' : 'text-slate-400'}">${step.name}</span>
                                        </div>
                                        ${step.action ? `<button class="mt-2 w-full py-1 bg-amber-500 text-white text-[8px] font-black rounded uppercase hover:bg-amber-600" onclick="confirmPaymentAction(this)">${step.action}</button>` : ''}
                                    </div>`).join('')}
                            </div>
                        </div>
                    </div>`).join('') || '<p class="text-xs text-slate-400 italic">Timeline initialization pending.</p>';
            }

            // Scans & Reports
            document.getElementById('detail-scans-list').innerHTML = `<div class="scan-card p-3 border"><i class="fa-solid fa-cube text-slate-300 text-xl mb-2"></i><span class="text-[9px] font-black uppercase">CBCT</span><p class="text-[8px] text-slate-400">Capture: 2025/12/10</p></div><div class="scan-card p-3 border"><i class="fa-solid fa-teeth text-slate-300 text-xl mb-2"></i><span class="text-[9px] font-black uppercase">STL Models</span><p class="text-[8px] text-slate-400">Capture: 2025/12/10</p></div>`;
            document.getElementById('analysis-summary').innerText = p.analysis || "Specialist analysis in progress.";
            document.getElementById('detail-reports-list').innerHTML = `<div class="flex justify-between items-center p-2 border rounded bg-slate-50 text-xs"><span>Blood Panel (CBC) - 2025/11/15</span><button class="text-blue-600 font-bold hover:underline">Download</button></div>`;

            // Questionnaire
            document.getElementById('q-mot').innerText = p.motivation;
            document.getElementById('q-pain').innerText = p.pains;
            document.getElementById('q-hist').innerText = p.qHist;

            // Hub videos & Referral Escalation
            document.getElementById('detail-hub-videos').innerHTML = p.videos.map(v => `
                <div class="p-4 bg-slate-50 border rounded-xl flex gap-6">
                    <div class="w-32 aspect-video bg-slate-900 rounded flex items-center justify-center"><i class="fa-solid fa-play text-white opacity-30"></i></div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">${v.date} Submission</span>
                            <button onclick="referVideoToAMD('${p.id}', '${v.id}')" class="px-3 py-1 bg-red-600 text-white text-[8px] font-black rounded uppercase shadow-sm hover:bg-red-700">Refer to AMD</button>
                        </div>
                        <p class="text-sm italic text-slate-600 mb-2 leading-relaxed">"${v.transcript}"</p>
                        <textarea class="w-full p-2 text-[10px] border rounded" placeholder="Add clinical note before escalation..."></textarea>
                    </div>
                </div>
            `).join('') || '<p class="text-center py-6 text-xs italic text-slate-400">No coaching videos for this case.</p>';

            // Treatment Log
            document.getElementById('detail-treatment-log').innerHTML = (p.internalNotes || []).map(n => `
                <div class="p-3 bg-slate-50 border rounded-lg text-xs">
                    <div class="flex justify-between font-bold text-slate-400 uppercase text-[9px] mb-1"><span>${n.date}</span><span>${n.author}</span></div>
                    <p class="italic">"${n.text}"</p>
                </div>
            `).join('') || '<p class="text-center text-xs italic text-slate-400">No logs found.</p>';

            switchMainPane('client-detail');
        }

        function renderVideoHub() {
            const list = document.getElementById('global-video-list');
            const videos = mockPatients.flatMap(p => p.videos.map(v => ({...v, pName: p.name, pId: p.id, clinic: p.clinic})));
            document.getElementById('video-count-badge').innerText = videos.length;
            list.innerHTML = videos.map(v => `
                <div class="section-card flex gap-6 items-start transition hover:border-purple-300 border border-transparent">
                    <div class="w-48 aspect-video bg-slate-900 rounded-xl flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-play text-white opacity-40"></i></div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="font-bold text-slate-800">${v.pName} <span class="text-xs text-slate-400 font-normal uppercase">(${v.pId})</span></h4>
                            <span class="text-[10px] font-black bg-purple-100 text-purple-700 px-2 py-0.5 rounded uppercase tracking-tighter">${v.clinic}</span>
                        </div>
                        <p class="text-xs text-slate-500 font-bold mb-3">${v.date} • Coaching Request</p>
                        <p class="text-sm italic text-slate-600 mb-4">"${v.transcript}"</p>
                        <div class="flex gap-2">
                            <button onclick="selectPatient('${v.pId}')" class="px-3 py-1.5 bg-slate-100 text-slate-700 text-[10px] font-black rounded uppercase">Open Case</button>
                            <button onclick="referVideoToAMD('${v.pId}', '${v.id}')" class="px-3 py-1.5 bg-red-600 text-white text-[10px] font-black rounded uppercase">Refer to AMD</button>
                        </div>
                    </div>
                </div>
            `).join('') || '<p class="text-center py-12 text-slate-400 italic">No historical videos in hub.</p>';
        }

        function renderActionQueue() {
            const list = document.getElementById('priority-list');
            const fullList = document.getElementById('task-list-full');
            const html = actionTasks.map(t => `
                <div class="section-card flex justify-between items-center border border-slate-50 transition hover:bg-slate-50 mb-3">
                    <div><p class="text-sm font-bold text-slate-800">${t.patient}</p><p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">${t.task}</p></div>
                    <div class="text-right">
                        <span class="text-[8px] font-black uppercase px-2 py-0.5 rounded ${t.priority === 'High' ? 'bg-red-100 text-red-600' : 'bg-amber-100 text-amber-600'} mr-3">${t.priority}</span>
                        <span class="text-[10px] font-bold text-slate-400 uppercase">${t.due}</span>
                    </div>
                </div>`).join('');
            if(list) list.innerHTML = html;
            if(fullList) fullList.innerHTML = html;
        }

        function renderRegistry() {
            const body = document.getElementById('patient-registry-body');
            body.innerHTML = mockPatients.map(p => `
                <tr class="hover:bg-slate-50 cursor-pointer" onclick="selectPatient('${p.id}')">
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-800">${p.name}</div>
                        <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${p.clinic} | ${p.id}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 bg-purple-50 text-purple-700 text-[10px] font-black rounded uppercase">${p.currentStatus}</span>
                    </td>
                    <td class="px-6 py-4 text-right text-xs font-bold text-slate-400">${p.totalDays}D AGE</td>
                </tr>
            `).join('');
        }

        function referVideoToAMD(pId, vId) {
            alert(`Coaching update ${vId} for patient ${pId} has been escalated to the Practitioner (AMD) for clinical review.`);
        }

        function confirmPaymentAction(btn) {
            btn.innerText = "Verifying...";
            setTimeout(() => {
                alert("Payment Verified. Case moved to Treatment Design phase.");
                btn.innerText = "Verified";
                btn.classList.replace("bg-amber-500", "bg-green-600");
                btn.disabled = true;
            }, 800);
        }

        function changeClinic(val) {
            currentClinic = val;
            const clinicsData = {
                harmony: { name: "Harmony Clinic Taipei", doc: "Dr. Ryan Chiang", patients: 2, scans: 1, videos: 2 },
                zen: { name: "Zen Dental Studio", doc: "Dr. C. Lin", patients: 2, scans: 1, videos: 1 },
                legacy: { name: "Legacy Airway Center", doc: "Dr. Peter Tseng", patients: 1, scans: 0, videos: 1 }
            };
            const c = clinicsData[val];
            document.getElementById('overview-clinic-name').innerText = `${c.name} Overview`;
            document.getElementById('overview-doctor-name').innerText = `Practitioner: ${c.doc}`;
            document.getElementById('stat-cases').innerText = c.patients;
            document.getElementById('stat-scans').innerText = c.scans;
            document.getElementById('stat-videos').innerText = c.videos;
            renderTracker();
        }

        function toggleLanguage() { currentLang = currentLang === 'en' ? 'zh' : 'en'; updateText(); }
        function updateText() {
            const btn = document.getElementById('lang-toggle');
            btn.textContent = currentLang === 'en' ? '中文' : 'English';
            renderTracker();
        }

        window.onload = () => { changeClinic('harmony'); renderActionQueue(); renderVideoHub(); renderRegistry(); updateText(); };
    </script>
</body>
</html>
